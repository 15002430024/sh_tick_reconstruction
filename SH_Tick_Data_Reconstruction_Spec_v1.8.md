# ä¸Šäº¤æ‰€é€ç¬”æ•°æ®æ‹†è§£è¿˜åŸæŠ€æœ¯éœ€æ±‚æ–‡æ¡£

> **ç‰ˆæœ¬**: v1.8  
> **æ—¥æœŸ**: 2026-01-26  
> **çŠ¶æ€**: å¾…è¯„å®¡

---

## ç›®å½•

1. [é¡¹ç›®èƒŒæ™¯ä¸ç›®æ ‡](#1-é¡¹ç›®èƒŒæ™¯ä¸ç›®æ ‡)
2. [æ•°æ®æºåˆ†æ](#2-æ•°æ®æºåˆ†æ)
3. [è¾“å‡ºSchemaå®šä¹‰](#3-è¾“å‡ºschemaå®šä¹‰)
4. [æ ¸å¿ƒå¤„ç†é€»è¾‘](#4-æ ¸å¿ƒå¤„ç†é€»è¾‘)
5. [OrderMapç¼“å­˜è®¾è®¡](#5-ordermapç¼“å­˜è®¾è®¡)
6. [æ—¶é—´è¿‡æ»¤è§„åˆ™](#6-æ—¶é—´è¿‡æ»¤è§„åˆ™)
7. [å¼‚å¸¸å¤„ç†ä¸è¾¹ç•Œæƒ…å†µ](#7-å¼‚å¸¸å¤„ç†ä¸è¾¹ç•Œæƒ…å†µ)
8. [å®Œæ•´å¤„ç†æµç¨‹ä¼ªä»£ç ](#8-å®Œæ•´å¤„ç†æµç¨‹ä¼ªä»£ç )
9. [æµ‹è¯•ç”¨ä¾‹è®¾è®¡](#9-æµ‹è¯•ç”¨ä¾‹è®¾è®¡)
10. [é™„å½•ï¼šæšä¸¾å€¼å®šä¹‰](#10-é™„å½•æšä¸¾å€¼å®šä¹‰)
11. [ä¸å›¾åƒæ„å»ºæ¶æ„å¯¹æ¥](#11-ä¸å›¾åƒæ„å»ºæ¶æ„å¯¹æ¥)

---

## 1. é¡¹ç›®èƒŒæ™¯ä¸ç›®æ ‡

### 1.1 é—®é¢˜é™ˆè¿°

ä¸Šäº¤æ‰€ Level-2 çš„ `auction_tick_merged_data` æ˜¯ä¸€ä¸ª**æ··åˆæ•°æ®æµ**ï¼Œå°†å§”æ‰˜ï¼ˆOrderï¼‰å’Œæˆäº¤ï¼ˆTradeï¼‰åˆå¹¶åœ¨åŒä¸€å¼ è¡¨ä¸­ã€‚æ›´å…³é”®çš„æ˜¯ï¼Œ**å³æ—¶æˆäº¤çš„å§”æ‰˜æ²¡æœ‰ Type='A' è®°å½•**â€”â€”å¦‚æœä¸€ç¬”ä¹°å•æŒ‚å‡ºåç«‹å³è¢«å…¨éƒ¨åƒæ‰ï¼Œä½ åœ¨æ•°æ®ä¸­åªä¼šçœ‹åˆ° `Type='T'` çš„æˆäº¤è®°å½•ï¼Œè€Œçœ‹ä¸åˆ°è¿™ç¬”å§”æ‰˜çš„"å‡ºç”Ÿè¯æ˜"ã€‚

è¿™ä¸æ·±äº¤æ‰€çš„æ•°æ®ç»“æ„å½¢æˆé²œæ˜å¯¹æ¯”ï¼šæ·±äº¤æ‰€æœ‰ç‹¬ç«‹çš„ `sz_order_data`ï¼ˆå§”æ‰˜è¡¨ï¼‰å’Œ `sz_trade_data`ï¼ˆæˆäº¤è¡¨ï¼‰ï¼Œæ¯ä¸€ç¬”å§”æ‰˜éƒ½æœ‰æ˜ç¡®çš„è®°å½•ã€‚

### 1.2 é¡¹ç›®ç›®æ ‡

é€šè¿‡ç®—æ³•é€»è¾‘ï¼Œå°†ä¸Šäº¤æ‰€çš„æ··åˆæ•°æ®æµæ‹†è§£è¿˜åŸä¸ºï¼š

| è¾“å‡ºè¡¨ï¼ˆé€»è¾‘åï¼‰ | è½ç›˜æ–‡ä»¶å | è¯´æ˜ | å¯¹æ ‡æ·±äº¤æ‰€ |
|------------------|-----------|------|-----------|
| `derived_sh_orders` | `{date}_sh_order_data.parquet` | è¿˜åŸåçš„å®Œæ•´å§”æ‰˜äº‹ä»¶è¡¨ | `sz_order_data` |
| `derived_sh_trades` | `{date}_sh_trade_data.parquet` | æ ‡å‡†åŒ–æˆäº¤è¡¨ | `sz_trade_data` |

**ğŸ”´ å‘½åæ˜ å°„è¯´æ˜**ï¼š
> - æ–‡æ¡£ä¸­ä½¿ç”¨ `derived_sh_orders` / `derived_sh_trades` ä½œä¸ºé€»è¾‘è¡¨åï¼ˆå¼ºè°ƒ"æ´¾ç”Ÿ/è¿˜åŸ"ï¼‰
> - å®é™…è½ç›˜æ–‡ä»¶å‘½åä¸º `{date}_sh_order_data.parquet` / `{date}_sh_trade_data.parquet`ï¼ˆä¸æ·±äº¤æ‰€å‘½åé£æ ¼å¯¹é½ï¼‰
> - ä¸¤è€…æŒ‡å‘åŒä¸€æ•°æ®ï¼Œä»…å‘½åè§†è§’ä¸åŒ

**æ ¸å¿ƒä»·å€¼**ï¼šè¿˜åŸ"æ¯å•æ„å›¾"ï¼Œæ•æ‰ä¸»åŠ›èµ„é‡‘çš„çœŸå®å§”æ‰˜è§„æ¨¡ï¼Œè€Œéè¢«äº¤æ˜“æ‰€æ’®åˆç³»ç»Ÿåˆ‡ç¢çš„å­æˆäº¤ã€‚

### 1.3 è®¾è®¡åŸåˆ™

1. **æ¯å•èšåˆ**ï¼šåŒä¸€ `OrderNO` çš„å¤šæ¡æˆäº¤è®°å½•å¿…é¡»èšåˆä¸ºä¸€æ¡å§”æ‰˜è®°å½•
2. **äº‹ä»¶å®Œæ•´æ€§**ï¼šå§”æ‰˜è¡¨åŒ…å« `New`ï¼ˆæ–°å¢ï¼‰å’Œ `Cancel`ï¼ˆæ’¤å•ï¼‰ä¸¤ç±»äº‹ä»¶
3. **ä»·æ ¼å®Œæ•´æ€§**ï¼šæ’¤å•è®°å½•å¿…é¡»å›æº¯åŸå§‹å§”æ‰˜ä»·æ ¼ï¼Œä¸å…è®¸è¾“å‡º `Price=0`
4. **æ—¶é—´çº¯ç²¹æ€§**ï¼šåªå¤„ç†è¿ç»­ç«ä»·æ—¶æ®µï¼Œå‰”é™¤é›†åˆç«ä»·æ•°æ®

---

## 2. æ•°æ®æºåˆ†æ

### 2.1 æ ¸å¿ƒè¡¨ç»“æ„

**è¾“å…¥è¡¨**: `auction_tick_merged_data` (mdl.4.24)

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | å…³é”®æ€§ |
|--------|------|------|--------|
| `BizIndex` | int | é€ç¬”åºå·ï¼ˆå…¨å±€å”¯ä¸€ï¼Œç”¨äºæ’åºï¼‰ | â­â­â­ |
| `Channel` | int | è¡Œæƒ…é€šé“å· | |
| `SecurityID` | varchar | è¯åˆ¸ä»£ç  | â­â­â­ |
| `TickTime` | int | æ—¶é—´ (HHMMSSmmm) | â­â­â­ |
| `Type` | varchar(1) | ç±»å‹: A/D/T/S | â­â­â­ |
| `BuyOrderNO` | int | ä¹°æ–¹è®¢å•å· | â­â­â­ |
| `SellOrderNO` | int | å–æ–¹è®¢å•å· | â­â­â­ |
| `Price` | decimal | ä»·æ ¼ï¼ˆæ’¤å•æ—¶æ— æ„ä¹‰ï¼‰ | â­â­ |
| `Qty` | int | æ•°é‡ | â­â­â­ |
| `TradeMoney` | decimal | æˆäº¤é‡‘é¢ / å·²æˆäº¤æ•°é‡ | â­ |
| `TickBSFlag` | varchar | ä¹°å–æ ‡è¯†: B/S/N | â­â­â­ |

### 2.2 Type æšä¸¾å€¼è¯¦è§£

| Type | å«ä¹‰ | æ•°æ®ç‰¹å¾ | å¤„ç†åŠ¨ä½œ |
|------|------|----------|----------|
| `A` | æ–°å¢å§”æ‰˜ï¼ˆæŒ‚å•ï¼‰ | å§”æ‰˜è¿›å…¥è®¢å•ç°¿ç­‰å¾…æˆäº¤ | â†’ å§”æ‰˜è¡¨ (New) |
| `T` | æˆäº¤ | å¯èƒ½åŒ…å«"éšå½¢å§”æ‰˜" | â†’ æˆäº¤è¡¨ + å¯èƒ½æ„é€ å§”æ‰˜ |
| `D` | æ’¤å• | Price å­—æ®µæ— æ„ä¹‰ | â†’ å§”æ‰˜è¡¨ (Cancel) |
| `S` | çŠ¶æ€å˜æ›´ | äº§å“çŠ¶æ€ä¿¡æ¯ | âŒ å‰”é™¤ |

### 2.3 TickBSFlag æšä¸¾å€¼è¯¦è§£

| TickBSFlag | Type=T æ—¶å«ä¹‰ | Type=A æ—¶å«ä¹‰ | Type=D æ—¶å«ä¹‰ |
|------------|--------------|--------------|--------------|
| `B` | ä¸»åŠ¨ä¹°å…¥ï¼ˆå¤–ç›˜ï¼‰ | ä¹°å…¥å§”æ‰˜ | æ’¤ä¹°å• |
| `S` | ä¸»åŠ¨å–å‡ºï¼ˆå†…ç›˜ï¼‰ | å–å‡ºå§”æ‰˜ | æ’¤å–å• |
| `N` | é›†åˆç«ä»·æˆäº¤ | æ— æ„ä¹‰ | æ— æ„ä¹‰ |

### 2.4 å…³é”®ä¸šåŠ¡è§„åˆ™ï¼ˆä¸Šäº¤æ‰€ç‰¹æœ‰ï¼‰

> **è§„åˆ™1**: è¿ç»­ç«ä»·é˜¶æ®µï¼ŒåŒä¸€ç¬”å§”æ‰˜äº§ç”Ÿçš„ä¸»åŠ¨æˆäº¤åŠå‰©ä½™æ–°å¢å§”æ‰˜è®¢å•æ•°æ®ï¼Œ**å…ˆå‘é€æˆäº¤æ•°æ®(T)ï¼Œå†å‘é€æˆäº¤åçš„æ–°å¢å§”æ‰˜è®¢å•æ•°æ®(A)**ã€‚

> **è§„åˆ™2**: **è‹¥ä¸€ç¬”è®¢å•è¢«ä¸€æ¬¡æ€§å…¨éƒ¨æ’®åˆï¼Œå°†ä¸ä¼šå‘å¸ƒè¯¥ç¬”è®¢å•çš„å§”æ‰˜ä¿¡æ¯**ã€‚

è¿™ä¸¤æ¡è§„åˆ™æ˜¯æœ¬é¡¹ç›®çš„æ ¸å¿ƒæŒ‘æˆ˜æ¥æºã€‚

---

## 3. è¾“å‡ºSchemaå®šä¹‰

### 3.1 è¿˜åŸåçš„å§”æ‰˜è¡¨ (`derived_sh_orders`)

**è½ç›˜æ–‡ä»¶å**: `{date}_sh_order_data.parquet`

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | æ¥æºé€»è¾‘ |
|------|------|------|----------|
| `SecurityID` | varchar | **è¯åˆ¸ä»£ç ** | â­ åŸå­—æ®µï¼ˆå…¨å¸‚åœºè¾“å‡ºå¿…éœ€ï¼‰ |
| `BizIndex` | int | **é¦–æ¬¡å‡ºç°çš„é€ç¬”åºå·** | â­ ç”¨äºæ’åºå’Œå®¡è®¡ |
| `TickTime` | int | å§”æ‰˜æ—¶é—´ (HHMMSSmmm) | è¯¥OrderIDé¦–æ¬¡å‡ºç°çš„æ—¶é—´ |
| `OrdID` | int | å§”æ‰˜å•å· | `BuyOrderNO` æˆ– `SellOrderNO` |
| `OrdType` | enum | `New` / `Cancel` | New=è¿˜åŸçš„å®Œæ•´å§”æ‰˜; Cancel=æ’¤å• |
| `Side` | enum | `B` / `S` | ä¹°å–æ–¹å‘ |
| `Price` | decimal | å§”æ‰˜ä»·æ ¼ | Açš„Price / Tçš„æˆäº¤ä»· / ç¼“å­˜å›æº¯ |
| `Qty` | int | **åŸå§‹å§”æ‰˜é‡** | â­ èšåˆè®¡ç®—: `âˆ‘T.Qty + A.Qty` |
| `IsAggressive` | **nullable bool** | **å…¥åœºè¿›æ”»æ€§æ ‡è¯†** | â­ åˆ¤æ–­å…¥åœºç¬é—´æ˜¯å¦è·¨è¶Šç›˜å£ï¼›æ’¤å•å¡« None |

**ğŸ”´ SecurityID å­—æ®µè¯´æ˜**ï¼š

> **ä¸ºä»€ä¹ˆéœ€è¦ SecurityID**ï¼š
> - å…¨å¸‚åœº parquet è¾“å‡ºéœ€è¦æŒ‰ `(SecurityID, TickTime, BizIndex)` ç‰©ç†æ’åº
> - ä¸‹æ¸¸å›¾åƒæ„å»ºéœ€è¦æŒ‰ SecurityID åˆ†ç»„å¤„ç†
> - ä¸æ·±äº¤æ‰€ `sz_order_data` ä¿æŒå­—æ®µå¯¹é½

**ğŸ”´ BizIndex å­—æ®µè¯´æ˜**ï¼š

> **ä¸ºä»€ä¹ˆéœ€è¦ BizIndex**ï¼š
> - èšåˆåçš„å§”æ‰˜è®°å½•æ¥è‡ªå¤šæ¡åŸå§‹æ•°æ®ï¼Œéœ€è¦ä¿ç•™æ’åºä¾æ®
> - åŒä¸€æ¯«ç§’å†…å¯èƒ½æœ‰å¤šç¬”å§”æ‰˜ï¼Œ`TickTime` æ— æ³•åŒºåˆ†å…ˆåé¡ºåº
> - ç”¨äºå®¡è®¡è¿½æº¯ï¼šå¯é€šè¿‡ `BizIndex` å®šä½åˆ°åŸå§‹æ•°æ®
> 
> **å–å€¼è§„åˆ™**ï¼šä¿ç•™è¯¥ `OrdID` **é¦–æ¬¡å‡ºç°æ—¶**çš„ `BizIndex`
> 
> **æ’åºä¿è¯**ï¼š
> - å•è‚¡ç¥¨ï¼šæŒ‰ `(TickTime, BizIndex)` ç‰©ç†æ’åº
> - å…¨å¸‚åœº parquetï¼šæŒ‰ `(SecurityID, TickTime, BizIndex)` ç‰©ç†æ’åº

**ğŸ”´ IsAggressive å­—æ®µè¯´æ˜ï¼ˆå…³é”®ï¼å®šä¹‰å·²æ”¶çª„ï¼‰**:

> **å®šä¹‰**ï¼šåˆ¤æ–­è¯¥å§”æ‰˜åœ¨**å…¥åœºç”³æŠ¥ç¬é—´**æ˜¯å¦å…·æœ‰è¿›æ”»æ€§ï¼ˆå³è·¨è¶Šç›˜å£ç«‹å³æˆäº¤ï¼‰ã€‚
> 
> **åˆ¤å®šé€»è¾‘**ï¼š
> - `True` (ä¸»åŠ¨è¿›æ”»/Taker)ï¼šè¯¥ `OrdID` çš„**é¦–æ¬¡**æ•°æ®è®°å½•ä¸º `Type='T'`ï¼ˆå‡ºç”Ÿå³æˆäº¤ï¼‰
> - `False` (è¢«åŠ¨é˜²å®ˆ/Maker)ï¼šè¯¥ `OrdID` çš„**é¦–æ¬¡**æ•°æ®è®°å½•ä¸º `Type='A'`ï¼ˆå‡ºç”Ÿå³æŒ‚å•ï¼‰
> - `None` (ä¸é€‚ç”¨)ï¼šæ’¤å•è®°å½•ï¼ˆ`OrdType='Cancel'`ï¼‰
> 
> **ç‰©ç†å«ä¹‰**ï¼šåŒºåˆ†"æ¶ˆè€—æµåŠ¨æ€§ï¼ˆLiquidity Takerï¼‰"ä¸"æä¾›æµåŠ¨æ€§ï¼ˆLiquidity Makerï¼‰"ã€‚

**âš ï¸ Parquet å­˜å‚¨å¤‡æ³¨**ï¼š

> `IsAggressive` å­—æ®µä½¿ç”¨ **Nullable Boolean** ç±»å‹ï¼ˆå³å…è®¸ç©ºå€¼çš„å¸ƒå°”ç±»å‹ï¼‰ã€‚
> 
> - Parquet ä¿å­˜æ—¶éœ€ä½¿ç”¨æ”¯æŒç©ºå€¼çš„ boolean ç±»å‹ï¼Œä»¥åŒºåˆ†**æ’¤å•**ï¼ˆNoneï¼‰ä¸**é˜²å®ˆå•**ï¼ˆFalseï¼‰
> - PyArrow ç¤ºä¾‹ï¼š`pa.field('IsAggressive', pa.bool_(), nullable=True)`
> - Polars ç¤ºä¾‹ï¼š`pl.Boolean`ï¼ˆé»˜è®¤æ”¯æŒ nullï¼‰

**âš ï¸ å¸¸è§è¯¯è§£ä¸æ¾„æ¸…**ï¼š

| åœºæ™¯ | é”™è¯¯ç†è§£ | æ­£ç¡®ç†è§£ |
|------|---------|---------|
| è¢«åŠ¨å•åç»­æˆäº¤ | 9:30æŒ‚å•(A)ï¼Œ10:00è¢«ç ¸æˆäº¤(T) â†’ True? | **False**ã€‚é¦–æ¬¡æ˜¯Aï¼Œæ°¸è¿œæ˜¯Maker |
| ä¸»åŠ¨å•éƒ¨åˆ†æˆäº¤ | å…ˆæˆäº¤(T)ï¼Œå†æŒ‚å•(A) â†’ Mixed? | **True**ã€‚é¦–æ¬¡æ˜¯Tï¼Œæ°¸è¿œæ˜¯Taker |
| çº¯æŒ‚å• | å…¨ç¨‹åªæœ‰Aè®°å½• â†’ False | **False**ã€‚æ­£ç¡® |
| å³æ—¶å…¨éƒ¨æˆäº¤ | å…¨ç¨‹åªæœ‰Tè®°å½•ï¼Œæ— A â†’ True | **True**ã€‚æ­£ç¡® |
| **æ’¤å•è®°å½•** | IsAggressive åº”è¯¥æ˜¯ False? | **None**ã€‚æ’¤å•ä¸é€‚ç”¨è¿›æ”»æ€§åˆ¤å®šï¼Œä½¿ç”¨ Nullable Bool å¡« None |

**ğŸ”´ å…³é”®ï¼šIsAggressive åªçœ‹"å‡ºç”Ÿæ–¹å¼"ï¼Œä¸çœ‹"åç»­ç»å†"**

```python
# æ­£ç¡®çš„åˆ¤å®šé€»è¾‘
def compute_is_aggressive(order_no: int, first_record_type: str) -> bool:
    """
    IsAggressive åˆ¤å®šï¼šåªçœ‹é¦–æ¬¡å‡ºç°çš„è®°å½•ç±»å‹
    
    Args:
        order_no: è®¢å•å·
        first_record_type: è¯¥OrderIDé¦–æ¬¡å‡ºç°æ—¶çš„Type ('A' æˆ– 'T')
    
    Returns:
        True if é¦–æ¬¡æ˜¯Type='T'ï¼ˆå‡ºç”Ÿå³æˆäº¤ï¼‰
        False if é¦–æ¬¡æ˜¯Type='A'ï¼ˆå‡ºç”Ÿå³æŒ‚å•ï¼‰
    """
    return first_record_type == 'T'
```

**é‡è¦è®¾è®¡å†³ç­–**ï¼š
> âš ï¸ **åªè¿˜åŸä¸»åŠ¨æ–¹ï¼Œä¸å¤„ç†è¢«åŠ¨æ–¹**  
> è¢«åŠ¨æ–¹ï¼ˆè¢«åƒæ‰çš„ç›˜å£å•ï¼‰åœ¨ä¹‹å‰æŒ‚å•æ—¶å·²ç»æœ‰ Type='A' è®°å½•ã€‚å¦‚æœé”™è¯¯åœ°ä» Type='T' è¿˜åŸè¢«åŠ¨æ–¹ï¼Œä¼šå¯¼è‡´é€šé“11/12åƒç´ å€¼è™šé«˜ä¸€å€ã€‚

### 3.2 æ ‡å‡†åŒ–æˆäº¤è¡¨ (`derived_sh_trades`)

**è½ç›˜æ–‡ä»¶å**: `{date}_sh_trade_data.parquet`

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | æ¥æº |
|------|------|------|------|
| `SecurityID` | varchar | è¯åˆ¸ä»£ç  | åŸå­—æ®µ |
| `TickTime` | int | æˆäº¤æ—¶é—´ | åŸ `TickTime` |
| `BizIndex` | int | é€ç¬”åºå· | åŸ `BizIndex` |
| `BidOrdID` | int | ä¹°å•å· | åŸ `BuyOrderNO` |
| `AskOrdID` | int | å–å•å· | åŸ `SellOrderNO` |
| `Price` | decimal | æˆäº¤ä»· | åŸ `Price` |
| `Qty` | int | æˆäº¤é‡ | åŸ `Qty` |
| `TradeMoney` | decimal | æˆäº¤é‡‘é¢ | åŸ `TradeMoney` |
| `ActiveSide` | int | **ç»Ÿä¸€ä¸»åŠ¨æ–¹å‘** | â­ æ²ªæ·±ç»Ÿä¸€åŒ–å­—æ®µ |

**ActiveSide å­—æ®µè¯´æ˜**ï¼ˆå…³é”®ï¼æ²ªæ·±ç»Ÿä¸€åŒ–ï¼‰:
| å€¼ | å«ä¹‰ | ä¸Šäº¤æ‰€æ¥æº | æ·±äº¤æ‰€æ¥æº |
|----|------|-----------|-----------|
| 1 | ä¸»åŠ¨ä¹°å…¥ | `TickBSFlag='B'` | `BidApplSeqNum > OfferApplSeqNum` |
| 2 | ä¸»åŠ¨å–å‡º | `TickBSFlag='S'` | `OfferApplSeqNum > BidApplSeqNum` |
| 0 | æœªçŸ¥/é›†åˆç«ä»· | `TickBSFlag='N'` | ç›¸ç­‰æˆ–æ— æ³•åˆ¤æ–­ |

**ä¸ºä»€ä¹ˆå¿…é¡»åšActiveSideç»Ÿä¸€åŒ–**ï¼š
> V2è®¡åˆ’ä½¿ç”¨Dask/Polarså‘é‡åŒ–è®¡ç®—ï¼Œå¦‚æœä¸åœ¨æ•°æ®æ¸…æ´—é˜¶æ®µç»Ÿä¸€ç”Ÿæˆ `ActiveSide`ï¼Œåç»­å›¾åƒæ„å»ºæ—¶æ— æ³•å†™å‡ºé€šç”¨çš„ `groupby` é€»è¾‘ï¼Œä¼šè¢«è¿«å†™ä¸¤å¥—åˆ†æ”¯ä»£ç ã€‚

---

## 4. æ ¸å¿ƒå¤„ç†é€»è¾‘

### 4.1 æ•´ä½“å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    auction_tick_merged_data                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  1. æ—¶é—´è¿‡æ»¤     â”‚  å‰”é™¤é›†åˆç«ä»·
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  2. æŒ‰TickTime â”‚  ä¿è¯å¤„ç†é¡ºåº
                    â”‚  + BizIndexæ’åºâ”‚  (åŒé‡ä¿é™©)
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚               â”‚               â”‚
              â–¼               â–¼               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Type=T  â”‚     â”‚ Type=A  â”‚     â”‚ Type=D  â”‚
        â”‚  æˆäº¤   â”‚     â”‚  æŒ‚å•   â”‚     â”‚  æ’¤å•   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚               â”‚               â”‚
              â–¼               â–¼               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ç´¯åŠ åˆ°    â”‚     â”‚æ›´æ–°      â”‚     â”‚æŸ¥ç¼“å­˜    â”‚
        â”‚OrderMap â”‚     â”‚OrderMap â”‚     â”‚å›å¡«Price â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚               â”‚               â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  3. æ‰¹æ¬¡ç»“ç®—     â”‚  è¾“å‡ºèšåˆåçš„å§”æ‰˜
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ derived_sh_ordersâ”‚             â”‚ derived_sh_tradesâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 Type='T' æˆäº¤è®°å½•å¤„ç†

**æ ¸å¿ƒé€»è¾‘**ï¼šæ¯ä¸€ç¬”æˆäº¤éƒ½æ¶‰åŠä¹°å–åŒæ–¹ï¼Œä½†åªæœ‰**ä¸»åŠ¨æ–¹**éœ€è¦æ„é€ /ç´¯åŠ å§”æ‰˜ã€‚

```python
def process_trade(row, order_map, trade_list):
    """
    å¤„ç†ä¸€æ¡æˆäº¤è®°å½•
    
    Args:
        row: åŸå§‹æ•°æ®è¡Œ
        order_map: å§”æ‰˜ç¼“å­˜ {OrderNO: OrderContext}
        trade_list: æˆäº¤è¾“å‡ºåˆ—è¡¨
    """
    # ========== 1. ActiveSide ç»Ÿä¸€åŒ– ==========
    # ä¸Šäº¤æ‰€ç›´æ¥æ˜ å°„ TickBSFlag
    if row['TickBSFlag'] == 'B':
        active_side = 1  # ä¸»åŠ¨ä¹°å…¥
    elif row['TickBSFlag'] == 'S':
        active_side = 2  # ä¸»åŠ¨å–å‡º
    else:  # 'N' é›†åˆç«ä»·
        active_side = 0  # æœªçŸ¥
    
    # ========== 2. è¾“å‡ºåˆ°æˆäº¤è¡¨ ==========
    trade_list.append({
        'SecurityID': row['SecurityID'],
        'TickTime': row['TickTime'],
        'BizIndex': row['BizIndex'],
        'BidOrdID': row['BuyOrderNO'],
        'AskOrdID': row['SellOrderNO'],
        'Price': row['Price'],
        'Qty': row['Qty'],
        'TradeMoney': row['TradeMoney'],
        'ActiveSide': active_side  # â­ ç»Ÿä¸€åŒ–å­—æ®µ
    })
    
    # ========== 3. åªè¿˜åŸä¸»åŠ¨æ–¹ï¼ä¸å¤„ç†è¢«åŠ¨æ–¹ï¼==========
    # âš ï¸ å…³é”®è®¾è®¡å†³ç­–ï¼šè¢«åŠ¨æ–¹å·²æœ‰Type='A'è®°å½•ï¼Œä¸è¦é‡å¤è¿˜åŸ
    if active_side == 1:  # ä¸»åŠ¨ä¹°å…¥
        active_order_no = row['BuyOrderNO']
        side = 'B'
    elif active_side == 2:  # ä¸»åŠ¨å–å‡º
        active_order_no = row['SellOrderNO']
        side = 'S'
    else:  # é›†åˆç«ä»·ï¼Œåº”å·²è¢«æ—¶é—´è¿‡æ»¤å‰”é™¤
        return
    
    # ========== 4. ç´¯åŠ åˆ°ç¼“å­˜ï¼ˆæ„é€ éšå¼å§”æ‰˜ï¼‰==========
    if active_order_no not in order_map:
        order_map[active_order_no] = OrderContext(
            order_no=active_order_no,
            side=side,
            first_time=row['TickTime'],
            first_biz_index=row['BizIndex'],  # â­ ä¿å­˜é¦–æ¬¡å‡ºç°çš„BizIndex
            price=row['Price'],  # ç”¨æˆäº¤ä»·ä½œä¸ºå§”æ‰˜ä»·
            is_aggressive=True   # â­ æ¥è‡ªTï¼Œæ ‡è®°ä¸ºä¸»åŠ¨
        )
    
    order_map[active_order_no].add_trade_qty(row['Qty'])
    order_map[active_order_no].trade_price = row['Price']  # æ›´æ–°æœ€æ–°æˆäº¤ä»·
```

### 4.3 Type='A' æŒ‚å•è®°å½•å¤„ç†

**æ ¸å¿ƒé€»è¾‘**ï¼šæŒ‚å•è®°å½•æ˜¯"å‰©ä½™éƒ¨åˆ†"ï¼Œéœ€è¦ä¸ä¹‹å‰çš„æˆäº¤ç´¯åŠ ã€‚

```python
def process_add_order(row, order_map):
    """
    å¤„ç†ä¸€æ¡æ–°å¢å§”æ‰˜è®°å½•
    
    æ³¨æ„ï¼šæ ¹æ®ä¸Šäº¤æ‰€è§„åˆ™ï¼Œå¦‚æœæœ‰æˆäº¤ï¼ŒType='T' å…ˆåˆ°ï¼ŒType='A' ååˆ°
    """
    if row['TickBSFlag'] == 'B':
        order_no = row['BuyOrderNO']
        side = 'B'
    else:  # 'S'
        order_no = row['SellOrderNO']
        side = 'S'
    
    if order_no in order_map:
        # å·²æœ‰æˆäº¤è®°å½•ï¼Œè¿™æ˜¯"éƒ¨åˆ†æˆäº¤åçš„å‰©ä½™æŒ‚å•"
        # â­ is_aggressive ä¿æŒ Trueï¼ˆå› ä¸ºå®ƒå…ˆä¸»åŠ¨åƒå•äº†ï¼‰
        # â­ first_biz_index ä¿æŒä¸å˜ï¼ˆå–é¦–æ¬¡å‡ºç°çš„ï¼‰
        order_map[order_no].add_resting_qty(row['Qty'])
        order_map[order_no].resting_price = row['Price']
        order_map[order_no].has_resting = True
    else:
        # çº¯æŒ‚å•ï¼Œæ²¡æœ‰æˆäº¤
        # â­ is_aggressive = Falseï¼ˆè¢«åŠ¨ç­‰å¾…æˆäº¤ï¼‰
        order_map[order_no] = OrderContext(
            order_no=order_no,
            side=side,
            first_time=row['TickTime'],
            first_biz_index=row['BizIndex'],  # â­ ä¿å­˜é¦–æ¬¡å‡ºç°çš„BizIndex
            price=row['Price'],
            is_aggressive=False  # â­ çº¯æŒ‚å•ï¼Œæ ‡è®°ä¸ºéä¸»åŠ¨
        )
        order_map[order_no].add_resting_qty(row['Qty'])
        order_map[order_no].has_resting = True
```

### 4.4 Type='D' æ’¤å•è®°å½•å¤„ç†

**æ ¸å¿ƒé€»è¾‘**ï¼šæ’¤å•çš„ Price å­—æ®µæ— æ„ä¹‰ï¼Œå¿…é¡»ä»ç¼“å­˜å›æº¯åŸå§‹å§”æ‰˜ä»·ã€‚

```python
def process_delete_order(row, order_map, order_output_list, last_price):
    """
    å¤„ç†ä¸€æ¡æ’¤å•è®°å½•
    
    Args:
        last_price: æœ€æ–°æˆäº¤ä»·ï¼ˆæœ€ç»ˆå…œåº•ç”¨ï¼‰
    """
    if row['TickBSFlag'] == 'B':
        order_no = row['BuyOrderNO']
        side = 'B'
    else:  # 'S'
        order_no = row['SellOrderNO']
        side = 'S'
    
    # ========== åˆ†çº§å…œåº•ç­–ç•¥ ==========
    
    # Level 0: ä¼˜å…ˆæ£€æŸ¥æ•°æ®æºè‡ªå¸¦çš„Price
    if row['Price'] is not None and row['Price'] > 0:
        cancel_price = row['Price']
        price_source = 'original'
    
    # Level 1: æŸ¥æœ¬åœ°ç¼“å­˜
    elif order_no in order_map:
        cancel_price = order_map[order_no].get_price()
        price_source = 'cache'
    
    # Level 2: æœ€ç»ˆå…œåº• - ç”¨æœ€æ–°æˆäº¤ä»·
    else:
        cancel_price = last_price
        price_source = 'last_price_fallback'
        # å¯é€‰ï¼šè®°å½•å‘Šè­¦æ—¥å¿—
        log_warning(f"Cancel order {order_no} price fallback to last_price")
    
    # è¾“å‡ºæ’¤å•è®°å½•
    order_output_list.append({
        'SecurityID': row['SecurityID'],
        'BizIndex': row['BizIndex'],  # â­ æ’¤å•è®°å½•è‡ªèº«çš„BizIndex
        'TickTime': row['TickTime'],
        'OrdID': order_no,
        'OrdType': 'Cancel',
        'Side': side,
        'Price': cancel_price,
        'Qty': row['Qty'],
        'IsAggressive': None  # â­ æ’¤å•ä¸é€‚ç”¨è¿›æ”»æ€§åˆ¤å®šï¼Œå¡« None (Nullable Bool)
    })
```

### 4.5 æ¯å•èšåˆç»“ç®—

**å…³é”®é—®é¢˜**ï¼šä»€ä¹ˆæ—¶å€™è¾“å‡ºèšåˆåçš„å§”æ‰˜è®°å½•ï¼Ÿ

**ç­–ç•¥**ï¼šæ‰¹å¤„ç†æ¨¡å¼ â€”â€” å¤„ç†å®Œå½“æ—¥æ‰€æœ‰æ•°æ®åï¼Œéå† `order_map` è¾“å‡ºã€‚

```python
def settle_orders(order_map, order_output_list, security_id):
    """
    ç»“ç®—æ‰€æœ‰ç¼“å­˜çš„å§”æ‰˜ï¼Œè¾“å‡ºèšåˆåçš„Newè®°å½•
    """
    for order_no, ctx in order_map.items():
        # è®¡ç®—åŸå§‹å§”æ‰˜é‡ = æˆäº¤é‡ + æŒ‚å•é‡
        total_qty = ctx.trade_qty + ctx.resting_qty
        
        # ç¡®å®šå§”æ‰˜ä»·æ ¼
        # ä¼˜å…ˆç”¨æŒ‚å•ä»·ï¼ˆæ›´å‡†ç¡®åæ˜ å§”æ‰˜æ„å›¾ï¼‰ï¼Œå…¶æ¬¡ç”¨æˆäº¤ä»·
        price = ctx.resting_price if ctx.resting_price else ctx.trade_price
        
        order_output_list.append({
            'SecurityID': security_id,  # â­ æ·»åŠ  SecurityID
            'BizIndex': ctx.first_biz_index,  # â­ é¦–æ¬¡å‡ºç°çš„BizIndex
            'TickTime': ctx.first_time,
            'OrdID': order_no,
            'OrdType': 'New',
            'Side': ctx.side,
            'Price': price,
            'Qty': total_qty,
            'IsAggressive': ctx.is_aggressive  # â­ ç”¨äºé€šé“åˆ†æµ
        })
```

**IsAggressive ä¸é€šé“æ˜ å°„å…³ç³»**ï¼š

| IsAggressive | Side | æ˜ å°„é€šé“ | ç‰©ç†å«ä¹‰ |
|--------------|------|----------|----------|
| True | B | é€šé“ 9 | ä¸»åŠ¨ä¹°å…¥å§”æ‰˜ï¼ˆè¿›æ”»ï¼‰ |
| True | S | é€šé“ 10 | ä¸»åŠ¨å–å‡ºå§”æ‰˜ï¼ˆè¿›æ”»ï¼‰ |
| False | B | é€šé“ 11 | éä¸»åŠ¨ä¹°å…¥å§”æ‰˜ï¼ˆé˜²å®ˆ/æŒ‚å•ï¼‰ |
| False | S | é€šé“ 12 | éä¸»åŠ¨å–å‡ºå§”æ‰˜ï¼ˆé˜²å®ˆ/æŒ‚å•ï¼‰ |
| True or False | B | é€šé“ 7 | å…¨éƒ¨ä¹°å•ï¼ˆ7 = 9 + 11ï¼‰ |
| True or False | S | é€šé“ 8 | å…¨éƒ¨å–å•ï¼ˆ8 = 10 + 12ï¼‰ |

---

## 5. OrderMapç¼“å­˜è®¾è®¡

### 5.1 æ•°æ®ç»“æ„

```python
@dataclass
class OrderContext:
    """å•ä¸ªè®¢å•çš„ä¸Šä¸‹æ–‡ä¿¡æ¯"""
    order_no: int           # è®¢å•å·
    side: str               # 'B' or 'S'
    first_time: int         # é¦–æ¬¡å‡ºç°æ—¶é—´
    first_biz_index: int    # â­ é¦–æ¬¡å‡ºç°çš„BizIndexï¼ˆç”¨äºæ’åºå’Œå®¡è®¡ï¼‰
    
    trade_qty: int = 0      # ç´¯è®¡æˆäº¤é‡
    resting_qty: int = 0    # æŒ‚å•é‡
    
    trade_price: float = 0  # æœ€æ–°æˆäº¤ä»·
    resting_price: float = 0  # æŒ‚å•ä»·
    
    is_aggressive: bool = False  # â­ å…¥åœºè¿›æ”»æ€§ï¼ˆåªçœ‹é¦–æ¬¡å‡ºç°ç±»å‹ï¼‰
    has_resting: bool = False    # â­ æ˜¯å¦æœ‰æŒ‚å•è®°å½•
    
    def add_trade_qty(self, qty: int):
        self.trade_qty += qty
    
    def add_resting_qty(self, qty: int):
        self.resting_qty += qty
    
    def get_price(self) -> float:
        """è·å–å§”æ‰˜ä»·æ ¼ï¼Œä¼˜å…ˆæŒ‚å•ä»·"""
        return self.resting_price if self.resting_price > 0 else self.trade_price
    
    def get_total_qty(self) -> int:
        """è·å–åŸå§‹å§”æ‰˜æ€»é‡"""
        return self.trade_qty + self.resting_qty
```

**ğŸ”´ IsAggressive åˆ¤å®šé€»è¾‘ï¼ˆå…¥åœºç¬é—´åˆ¤å®šï¼‰**ï¼š

> **æ ¸å¿ƒè§„åˆ™**ï¼šåªçœ‹è¯¥ OrdID **é¦–æ¬¡å‡ºç°æ—¶**çš„è®°å½•ç±»å‹ï¼Œ**ä¸çœ‹åç»­ç»å†**ã€‚

| é¦–æ¬¡å‡ºç°ç±»å‹ | IsAggressive | ç‰©ç†å«ä¹‰ | è¯´æ˜ |
|-------------|--------------|----------|------|
| `Type='T'` | `True` | Takerï¼ˆæ¶ˆè€—æµåŠ¨æ€§ï¼‰ | å‡ºç”Ÿå³æˆäº¤ï¼Œè·¨è¶Šç›˜å£ |
| `Type='A'` | `False` | Makerï¼ˆæä¾›æµåŠ¨æ€§ï¼‰ | å‡ºç”Ÿå³æŒ‚å•ï¼Œç­‰å¾…æˆäº¤ |

**é‡è¦æ¾„æ¸…**ï¼š
- âœ… è¢«åŠ¨å•åç»­è¢«ç ¸æˆäº¤ â†’ ä»ç„¶æ˜¯ `False`ï¼ˆé¦–æ¬¡æ˜¯Aï¼‰
- âœ… ä¸»åŠ¨å•éƒ¨åˆ†æˆäº¤åè½¬æŒ‚å• â†’ ä»ç„¶æ˜¯ `True`ï¼ˆé¦–æ¬¡æ˜¯Tï¼‰
- âŒ é”™è¯¯ç†è§£ï¼š"äº§ç”Ÿè¿‡æˆäº¤å°±æ˜¯True" â€” è¿™ä¼šæ±¡æŸ“é€šé“9/10

### 5.2 ç¼“å­˜ç­–ç•¥

| åœºæ™¯ | ç­–ç•¥ |
|------|------|
| æ­£å¸¸å¤„ç† | æŒ‰ `SecurityID` åˆ†ç»„ï¼Œæ¯åªè‚¡ç¥¨ç‹¬ç«‹ç»´æŠ¤ `order_map` |
| å†…å­˜ç®¡ç† | æ¯æ—¥å¤„ç†å®Œåæ¸…ç©ºç¼“å­˜ |
| è·¨æ—¥å¤„ç† | `OrderNO` åœ¨åŒä¸€å¤©å†…å”¯ä¸€ï¼Œè·¨æ—¥é‡ç½® |

### 5.3 å¼‚å¸¸å¤„ç†

```python
def get_price_with_fallback(order_no, order_map, last_price):
    """
    åˆ†çº§å…œåº•è·å–å§”æ‰˜ä»·æ ¼
    
    Level 0: æ•°æ®æºè‡ªå¸¦ï¼ˆè°ƒç”¨æ–¹å¤„ç†ï¼‰
    Level 1: æœ¬åœ°ç¼“å­˜
    Level 2: æœ€æ–°æˆäº¤ä»·
    """
    if order_no in order_map:
        return order_map[order_no].get_price(), 'cache'
    else:
        return last_price, 'fallback'
```

---

## 6. æ—¶é—´è¿‡æ»¤è§„åˆ™

### 6.1 è¿‡æ»¤é€»è¾‘

```python
def is_continuous_trading_time(tick_time: int) -> bool:
    """
    åˆ¤æ–­æ˜¯å¦ä¸ºè¿ç»­ç«ä»·æ—¶æ®µ
    
    Args:
        tick_time: HHMMSSmmm æ ¼å¼çš„æ—¶é—´ï¼Œå¦‚ 93000540
    
    Returns:
        True if è¿ç»­ç«ä»·æ—¶æ®µ
    """
    # æå–å°æ—¶åˆ†é’Ÿ
    hhmm = tick_time // 100000  # å»æ‰ç§’å’Œæ¯«ç§’
    
    # ä¸Šåˆè¿ç»­ç«ä»·: 09:30:00 - 11:30:00
    if 930 <= hhmm < 1130:
        return True
    
    # ä¸‹åˆè¿ç»­ç«ä»·: 13:00:00 - 14:57:00
    # âœ… æ²ªæ·±ç»Ÿä¸€ï¼šå‰”é™¤æ”¶ç›˜é›†åˆç«ä»·ï¼ˆ14:57-15:00ï¼‰
    if 1300 <= hhmm < 1457:
        return True
    
    return False
```

### 6.2 æ—¶é—´æ®µè¯´æ˜

| æ—¶é—´æ®µ | é˜¶æ®µ | å¤„ç† | åŸå›  |
|--------|------|------|------|
| 09:15 - 09:25 | å¼€ç›˜é›†åˆç«ä»· | âŒ å‰”é™¤ | ç»Ÿä¸€æ’®åˆï¼Œæ— ä¸»åŠ¨æ–¹å‘æ¦‚å¿µ |
| 09:25 - 09:30 | é™é»˜æœŸ | âŒ å‰”é™¤ | æ— äº¤æ˜“ |
| 09:30 - 11:30 | è¿ç»­ç«ä»·(ä¸Šåˆ) | âœ… ä¿ç•™ | **æ ¸å¿ƒæ•°æ®åŒº** |
| 11:30 - 13:00 | åˆé—´ä¼‘å¸‚ | âŒ å‰”é™¤ | æ— äº¤æ˜“ |
| 13:00 - 14:57 | è¿ç»­ç«ä»·(ä¸‹åˆ) | âœ… ä¿ç•™ | **æ ¸å¿ƒæ•°æ®åŒº** |
| 14:57 - 15:00 | æ”¶ç›˜é›†åˆç«ä»· | âŒ å‰”é™¤ | 2025å¹´åæ²ªæ·±å‡æœ‰ |

> âœ… **æ²ªæ·±ç»Ÿä¸€å¤„ç†**ï¼š2025å¹´åä¸Šäº¤æ‰€ä¹Ÿå¼•å…¥æ”¶ç›˜é›†åˆç«ä»·ï¼Œ
> ä¸ºä¿è¯æ•°æ®åˆ†å¸ƒä¸€è‡´æ€§å’Œæ¨¡å‹ç¨³å®šæ€§ï¼Œæ²ªæ·±ç»Ÿä¸€å‰”é™¤ 14:57-15:00 æ—¶æ®µã€‚

---

## 7. å¼‚å¸¸å¤„ç†ä¸è¾¹ç•Œæƒ…å†µ

### 7.1 BizIndex è·³å·æ£€æµ‹

```python
def check_bizindex_continuity(df, security_id):
    """
    æ£€æµ‹ BizIndex æ˜¯å¦è¿ç»­
    
    è·³å·æ„å‘³ç€å¯èƒ½æœ‰æ•°æ®ä¸¢å¤±ï¼ŒOrderMap å¯èƒ½ä¸å®Œæ•´
    """
    biz_indices = df['BizIndex'].sort_values()
    gaps = biz_indices.diff().dropna()
    
    large_gaps = gaps[gaps > 1]
    if len(large_gaps) > 0:
        log_warning(f"{security_id}: BizIndex gaps detected: {large_gaps.tolist()}")
        return False
    return True
```

### 7.2 Price=0 æˆ– NULL å¤„ç†

| åœºæ™¯ | Type | å¤„ç†ç­–ç•¥ |
|------|------|----------|
| æ­£å¸¸æˆäº¤ | T | Price åº”è¯¥ > 0ï¼Œå¦åˆ™æ ‡è®°å¼‚å¸¸ |
| å¸‚ä»·å•æˆäº¤ | T | Price æ˜¯æˆäº¤ä»·ï¼Œæ­£å¸¸å¤„ç† |
| æŒ‚å• | A | Price åº”è¯¥ > 0ï¼Œå¦åˆ™æ ‡è®°å¼‚å¸¸ |
| æ’¤å• | D | Price æ— æ„ä¹‰ï¼Œèµ°å…œåº•ç­–ç•¥ |

### 7.3 OrderNO ä¸º 0 çš„å¤„ç†

```python
# æ ¹æ®æ•°æ®å­—å…¸ï¼š
# - å–æ–¹è®¢å•: BuyOrderNO = 0
# - ä¹°æ–¹è®¢å•: SellOrderNO = 0

def get_relevant_order_no(row):
    """è·å–æœ‰æ•ˆçš„è®¢å•å·"""
    if row['TickBSFlag'] == 'B':
        return row['BuyOrderNO']
    elif row['TickBSFlag'] == 'S':
        return row['SellOrderNO']
    else:
        return None  # é›†åˆç«ä»·ï¼Œåº”å·²è¢«è¿‡æ»¤
```

### 7.4 TradeMoney å­—æ®µçš„ç‰¹æ®Šå«ä¹‰

> æ•°æ®å­—å…¸ï¼š`TradeMoney`: "æ–°å¢å§”æ‰˜æ—¶è¡¨ç¤ºå·²æˆäº¤çš„å§”æ‰˜æ•°é‡"

**æ³¨æ„**ï¼šè¿™æ˜¯ä¸€ä¸ªåç›´è§‰çš„è®¾è®¡ã€‚å¯¹äº `Type='A'`ï¼Œ`TradeMoney` å¯èƒ½è¡¨ç¤ºè¯¥å§”æ‰˜åœ¨æŒ‚å•å‰å·²ç»æˆäº¤çš„æ•°é‡ã€‚

```python
def validate_order_reconstruction(ctx, trade_money_from_a):
    """
    æ ¡éªŒæ¯å•è¿˜åŸé€»è¾‘
    
    å¦‚æœ Type='A' çš„ TradeMoney å­—æ®µæœ‰å€¼ï¼Œå¯ä»¥ç”¨å®ƒæ¥æ ¡éªŒ
    """
    if trade_money_from_a and trade_money_from_a > 0:
        expected_trade_qty = trade_money_from_a
        actual_trade_qty = ctx.trade_qty
        if abs(expected_trade_qty - actual_trade_qty) > 1:
            log_warning(f"Order {ctx.order_no}: trade_qty mismatch, "
                       f"expected={expected_trade_qty}, actual={actual_trade_qty}")
```

---

## 8. å®Œæ•´å¤„ç†æµç¨‹ä¼ªä»£ç 

```python
def reconstruct_sh_tick_data(df: pd.DataFrame, security_id: str) -> Tuple[List, List]:
    """
    ä¸Šäº¤æ‰€é€ç¬”æ•°æ®æ‹†è§£è¿˜åŸä¸»å‡½æ•°
    
    Args:
        df: å•åªè‚¡ç¥¨å½“æ—¥çš„ auction_tick_merged_data
        security_id: è¯åˆ¸ä»£ç 
    
    Returns:
        order_list: è¿˜åŸåçš„å§”æ‰˜åˆ—è¡¨
        trade_list: æ ‡å‡†åŒ–æˆäº¤åˆ—è¡¨
    """
    
    # ========== 1. é¢„å¤„ç† ==========
    
    # 1.1 å‰”é™¤çŠ¶æ€è®°å½•
    df = df[df['Type'] != 'S']
    
    # 1.2 æ—¶é—´è¿‡æ»¤ï¼ˆåªä¿ç•™è¿ç»­ç«ä»·æ—¶æ®µï¼‰
    df = df[df['TickTime'].apply(is_continuous_trading_time)]
    
    # 1.3 æŒ‰ TickTime + BizIndex æ’åºï¼ˆä¸¥æ ¼ç‰©ç†é¡ºåºï¼ŒåŒé‡ä¿é™©ï¼‰
    df = df.sort_values(['TickTime', 'BizIndex'])
    
    # 1.4 è¿ç»­æ€§æ£€æŸ¥
    check_bizindex_continuity(df, security_id)
    
    # ========== 2. åˆå§‹åŒ– ==========
    
    order_map = {}      # {OrderNO: OrderContext}
    order_list = []     # è¾“å‡ºï¼šå§”æ‰˜è®°å½•
    trade_list = []     # è¾“å‡ºï¼šæˆäº¤è®°å½•
    last_price = 0      # æœ€æ–°æˆäº¤ä»·ï¼ˆå…œåº•ç”¨ï¼‰
    
    # ========== 3. é€è¡Œå¤„ç† ==========
    
    for _, row in df.iterrows():
        row_type = row['Type']
        
        if row_type == 'T':
            # å¤„ç†æˆäº¤
            process_trade(row, order_map, trade_list)
            last_price = row['Price']  # æ›´æ–°æœ€æ–°æˆäº¤ä»·
            
        elif row_type == 'A':
            # å¤„ç†æ–°å¢å§”æ‰˜
            process_add_order(row, order_map)
            
        elif row_type == 'D':
            # å¤„ç†æ’¤å•ï¼ˆç›´æ¥è¾“å‡ºåˆ°order_listï¼‰
            process_delete_order(row, order_map, order_list, last_price)
    
    # ========== 4. ç»“ç®—ï¼šè¾“å‡ºæ‰€æœ‰èšåˆåçš„ New å§”æ‰˜ ==========
    
    settle_orders(order_map, order_list, security_id)
    
    # ========== 5. æ’åºè¾“å‡º ==========
    
    # æŒ‰ TickTime + BizIndex æ’åºï¼ˆå…³é”®ï¼šå¿…é¡»åŒ…å« BizIndex ä»¥ä¿æŒåŒæ¯«ç§’å†…çš„ç‰©ç†é¡ºåºï¼‰
    order_list.sort(key=lambda x: (x['TickTime'], x['BizIndex']))
    trade_list.sort(key=lambda x: (x['TickTime'], x['BizIndex']))
    
    return order_list, trade_list


# ========== æ‰¹é‡å¤„ç†å…¥å£ ==========

def process_daily_data(date: str, input_path: str, output_path: str):
    """
    å¤„ç†å•æ—¥å…¨å¸‚åœºæ•°æ®
    
    è¾“å‡ºæ–‡ä»¶ï¼š
    - {output_path}/{date}_sh_order_data.parquet
    - {output_path}/{date}_sh_trade_data.parquet
    """
    # è¯»å–æ•°æ®
    df = pd.read_parquet(input_path)
    
    all_orders = []
    all_trades = []
    
    # æŒ‰è‚¡ç¥¨åˆ†ç»„å¤„ç†
    for security_id, group_df in df.groupby('SecurityID'):
        orders, trades = reconstruct_sh_tick_data(group_df, security_id)
        all_orders.extend(orders)
        all_trades.extend(trades)
    
    # è¾“å‡ºï¼ˆå…³é”®ï¼šå¿…é¡»æŒ‰ SecurityID + TickTime + BizIndex æ’åºåå†å†™ parquetï¼‰
    orders_df = pd.DataFrame(all_orders)
    trades_df = pd.DataFrame(all_trades)
    
    # â­ å…¨å¸‚åœºç‰©ç†æ’åºï¼šæŒ‰ (SecurityID, TickTime, BizIndex) ä¿è¯å¾®è§‚é¡ºåº
    if not orders_df.empty:
        orders_df = orders_df.sort_values(['SecurityID', 'TickTime', 'BizIndex'])
    if not trades_df.empty:
        trades_df = trades_df.sort_values(['SecurityID', 'TickTime', 'BizIndex'])
    
    # â­ è½ç›˜æ–‡ä»¶å‘½åä¸æ·±äº¤æ‰€å¯¹é½
    orders_df.to_parquet(f"{output_path}/{date}_sh_order_data.parquet", index=False)
    trades_df.to_parquet(f"{output_path}/{date}_sh_trade_data.parquet", index=False)
```

---

## 9. æµ‹è¯•ç”¨ä¾‹è®¾è®¡

### 9.1 åœºæ™¯è¦†ç›–çŸ©é˜µ

| åœºæ™¯ | Typeåºåˆ— | æœŸæœ› IsAggressive | æœŸæœ› Qty | è¯´æ˜ |
|------|----------|-------------------|----------|------|
| å³æ—¶å…¨éƒ¨æˆäº¤ | T only | True | T.Qty | ä¸»åŠ¨åƒå•ï¼Œæ— å‰©ä½™ |
| éƒ¨åˆ†æˆäº¤åæŒ‚å• | T â†’ A | True | T.Qty + A.Qty | å…ˆåƒåæŒ‚ |
| çº¯æŒ‚å• | A only | False | A.Qty | è¢«åŠ¨ç­‰å¾… |
| å¤šæ¬¡éƒ¨åˆ†æˆäº¤ | T â†’ T â†’ A | True | Î£T.Qty + A.Qty | å¤šæ¬¡æˆäº¤ |
| æ’¤å• | A â†’ D | None (Cancel) | D.Qty | æ’¤å•ç‹¬ç«‹ |
| å…¨éƒ¨æˆäº¤åæ— æŒ‚å• | T â†’ T | True | Î£T.Qty | å®Œå…¨æˆäº¤ |

### 9.2 è¾¹ç•Œæµ‹è¯•ç”¨ä¾‹

```python
# ç”¨ä¾‹1: å³æ—¶å…¨éƒ¨æˆäº¤ï¼ˆåªæœ‰Tè®°å½•ï¼‰
test_case_1 = [
    {'Type': 'T', 'TickBSFlag': 'B', 'BuyOrderNO': 1001, 'SellOrderNO': 2001, 
     'Qty': 1000, 'Price': 10.5, 'TickTime': 93000100, 'BizIndex': 100}
]
# æœŸæœ›: orders æœ‰1æ¡, OrdID=1001, IsAggressive=True, Qty=1000

# ç”¨ä¾‹2: éƒ¨åˆ†æˆäº¤åè½¬æŒ‚å•ï¼ˆT â†’ Aï¼‰
test_case_2 = [
    {'Type': 'T', 'TickBSFlag': 'B', 'BuyOrderNO': 1002, 'SellOrderNO': 2002,
     'Qty': 600, 'Price': 10.5, 'TickTime': 93000200, 'BizIndex': 200},
    {'Type': 'A', 'TickBSFlag': 'B', 'BuyOrderNO': 1002, 'SellOrderNO': 0,
     'Qty': 400, 'Price': 10.5, 'TickTime': 93000201, 'BizIndex': 201}
]
# æœŸæœ›: orders æœ‰1æ¡, OrdID=1002, IsAggressive=True, Qty=1000

# ç”¨ä¾‹3: çº¯æŒ‚å•ï¼ˆåªæœ‰Aè®°å½•ï¼‰
test_case_3 = [
    {'Type': 'A', 'TickBSFlag': 'S', 'BuyOrderNO': 0, 'SellOrderNO': 3001,
     'Qty': 500, 'Price': 10.6, 'TickTime': 93000300, 'BizIndex': 300}
]
# æœŸæœ›: orders æœ‰1æ¡, OrdID=3001, IsAggressive=False, Qty=500

# ç”¨ä¾‹4: æ’¤å•ä»·æ ¼å›æº¯
test_case_4 = [
    {'Type': 'A', 'TickBSFlag': 'B', 'BuyOrderNO': 1004, 'SellOrderNO': 0,
     'Qty': 1000, 'Price': 10.5, 'TickTime': 93000400, 'BizIndex': 400},
    {'Type': 'D', 'TickBSFlag': 'B', 'BuyOrderNO': 1004, 'SellOrderNO': 0,
     'Qty': 500, 'Price': 0, 'TickTime': 93500400, 'BizIndex': 450}  # Price=0
]
# æœŸæœ›: æ’¤å•è®°å½• Price=10.5ï¼ˆä»ç¼“å­˜å›æº¯ï¼‰ï¼ŒIsAggressive=None

# ç”¨ä¾‹5: è¢«åŠ¨å•åç»­è¢«æˆäº¤ï¼ˆä¸åº”æ”¹å˜ IsAggressiveï¼‰
test_case_5 = [
    {'Type': 'A', 'TickBSFlag': 'S', 'BuyOrderNO': 0, 'SellOrderNO': 3002,
     'Qty': 1000, 'Price': 10.6, 'TickTime': 93000500, 'BizIndex': 500},
    # è¿™ç¬”å–å•è¢«ä¹°æ–¹åƒæ‰ï¼Œäº§ç”Ÿæˆäº¤ï¼ˆ3002æ˜¯è¢«åŠ¨æ–¹ï¼‰
    {'Type': 'T', 'TickBSFlag': 'B', 'BuyOrderNO': 1005, 'SellOrderNO': 3002,
     'Qty': 500, 'Price': 10.6, 'TickTime': 94000500, 'BizIndex': 550}
]
# æœŸæœ›: OrdID=3002 çš„ IsAggressive=Falseï¼ˆé¦–æ¬¡æ˜¯Aï¼‰
#       OrdID=1005 çš„ IsAggressive=Trueï¼ˆæ¥è‡ªTï¼Œä¸”æ˜¯ä¸»åŠ¨æ–¹ï¼‰
```

### 9.3 é€šé“æ•°å­¦éªŒè¯

```python
def verify_channel_math(orders_df):
    """
    éªŒè¯é€šé“æ•°å­¦å…³ç³»
    
    Ch7 (å…¨éƒ¨ä¹°å•) = Ch9 (ä¸»åŠ¨ä¹°) + Ch11 (éä¸»åŠ¨ä¹°)
    Ch8 (å…¨éƒ¨å–å•) = Ch10 (ä¸»åŠ¨å–) + Ch12 (éä¸»åŠ¨å–)
    """
    new_orders = orders_df[orders_df['OrdType'] == 'New']
    
    # ä¹°æ–¹
    ch7 = new_orders[new_orders['Side'] == 'B']['Qty'].sum()
    ch9 = new_orders[(new_orders['Side'] == 'B') & (new_orders['IsAggressive'] == True)]['Qty'].sum()
    ch11 = new_orders[(new_orders['Side'] == 'B') & (new_orders['IsAggressive'] == False)]['Qty'].sum()
    
    assert ch7 == ch9 + ch11, f"Ch7({ch7}) != Ch9({ch9}) + Ch11({ch11})"
    
    # å–æ–¹
    ch8 = new_orders[new_orders['Side'] == 'S']['Qty'].sum()
    ch10 = new_orders[(new_orders['Side'] == 'S') & (new_orders['IsAggressive'] == True)]['Qty'].sum()
    ch12 = new_orders[(new_orders['Side'] == 'S') & (new_orders['IsAggressive'] == False)]['Qty'].sum()
    
    assert ch8 == ch10 + ch12, f"Ch8({ch8}) != Ch10({ch10}) + Ch12({ch12})"
    
    print("âœ… Channel math verification passed!")
```

---

## 10. é™„å½•ï¼šæšä¸¾å€¼å®šä¹‰

### 10.1 OrdType

| å€¼ | å«ä¹‰ | è¯´æ˜ |
|----|------|------|
| `New` | æ–°å¢å§”æ‰˜ | è¿˜åŸåçš„å®Œæ•´å§”æ‰˜ï¼ˆå«éšå¼å§”æ‰˜ï¼‰ |
| `Cancel` | æ’¤å• | åŸå§‹ Type='D' |

### 10.2 Side

| å€¼ | å«ä¹‰ |
|----|------|
| `B` | ä¹°å…¥ (Buy) |
| `S` | å–å‡º (Sell) |

### 10.3 IsAggressiveï¼ˆå…¥åœºè¿›æ”»æ€§æ ‡è¯†ï¼‰

> **å®šä¹‰**ï¼šåˆ¤æ–­è¯¥å§”æ‰˜åœ¨**å…¥åœºç”³æŠ¥ç¬é—´**æ˜¯å¦å…·æœ‰è¿›æ”»æ€§ï¼ˆå³è·¨è¶Šç›˜å£ç«‹å³æˆäº¤ï¼‰ã€‚

| å€¼ | å«ä¹‰ | åˆ¤å®šæ¡ä»¶ | ç‰©ç†å«ä¹‰ | æ˜ å°„é€šé“ |
|----|------|----------|----------|----------|
| `True` | ä¸»åŠ¨è¿›æ”» (Taker) | OrdID **é¦–æ¬¡**å‡ºç°åœ¨ `Type='T'` | æ¶ˆè€—æµåŠ¨æ€§ | é€šé“ 9/10 |
| `False` | è¢«åŠ¨é˜²å®ˆ (Maker) | OrdID **é¦–æ¬¡**å‡ºç°åœ¨ `Type='A'` | æä¾›æµåŠ¨æ€§ | é€šé“ 11/12 |
| `None` | ä¸é€‚ç”¨ | `OrdType='Cancel'` | æ’¤å• | é€šé“ 13/14 |

**ğŸ”´ å…³é”®å¼ºè°ƒ**ï¼š
- åªçœ‹"å‡ºç”Ÿæ–¹å¼"ï¼Œ**ä¸çœ‹"åç»­ç»å†"**
- è¢«åŠ¨å•å³ä½¿åç»­æˆäº¤ï¼Œä»ç„¶æ˜¯ `False`
- ä¸»åŠ¨å•å³ä½¿åç»­è½¬æŒ‚å•ï¼Œä»ç„¶æ˜¯ `True`
- æ’¤å•å¡« `None`ï¼Œä¸æ˜¯ `False`

### 10.4 ActiveSideï¼ˆç»Ÿä¸€ä¸»åŠ¨æ–¹å‘ï¼‰

| å€¼ | å«ä¹‰ | ä¸Šäº¤æ‰€æ¥æº | æ·±äº¤æ‰€æ¥æº |
|----|------|-----------|-----------|
| 1 | ä¸»åŠ¨ä¹°å…¥ï¼ˆå¤–ç›˜ï¼‰ | `TickBSFlag='B'` | `BidApplSeqNum > OfferApplSeqNum` |
| 2 | ä¸»åŠ¨å–å‡ºï¼ˆå†…ç›˜ï¼‰ | `TickBSFlag='S'` | `OfferApplSeqNum > BidApplSeqNum` |
| 0 | æœªçŸ¥/é›†åˆç«ä»· | `TickBSFlag='N'` | ä¸¤è€…ç›¸ç­‰ |

### 10.5 åŸå§‹Typeï¼ˆå‚è€ƒï¼‰

| å€¼ | å«ä¹‰ |
|----|------|
| `A` | Add Order (æ–°å¢å§”æ‰˜) |
| `T` | Trade (æˆäº¤) |
| `D` | Delete Order (æ’¤å•) |
| `S` | Status (çŠ¶æ€) - å‰”é™¤ |

### 10.6 åŸå§‹TickBSFlagï¼ˆå‚è€ƒï¼‰

| å€¼ | Type=Tæ—¶å«ä¹‰ | Type=Aæ—¶å«ä¹‰ |
|----|-------------|-------------|
| `B` | ä¸»åŠ¨ä¹°å…¥ï¼ˆå¤–ç›˜ï¼‰ | ä¹°å…¥å§”æ‰˜ |
| `S` | ä¸»åŠ¨å–å‡ºï¼ˆå†…ç›˜ï¼‰ | å–å‡ºå§”æ‰˜ |
| `N` | é›†åˆç«ä»·æˆäº¤ | - |


---

## 11. ä¸å›¾åƒæ„å»ºæ¶æ„å¯¹æ¥

### 11.1 æ•°æ®æµæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Phase 1: æ•°æ®æ¸…æ´—                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¸Šäº¤æ‰€åŸå§‹æ•°æ®                    æ·±äº¤æ‰€åŸå§‹æ•°æ®                      â”‚
â”‚  auction_tick_merged_data         sz_order_data + sz_trade_data     â”‚
â”‚           â”‚                                â”‚                         â”‚
â”‚           â–¼                                â–¼                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ æœ¬æ–‡æ¡£çš„æ‹†è§£é€»è¾‘  â”‚              â”‚   ç›´æ¥æ ‡å‡†åŒ–     â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚           â”‚                                â”‚                         â”‚
â”‚           â–¼                                â–¼                         â”‚
â”‚  {date}_sh_order_data.parquet     sz_order_data (æ ‡å‡†åŒ–)             â”‚
â”‚  {date}_sh_trade_data.parquet     sz_trade_data (+ ActiveSide)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Phase 2: å›¾åƒæ„å»º                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é€šé“ 0-6:   æ¥è‡ª trades è¡¨                                          â”‚
â”‚  é€šé“ 7-8:   æ¥è‡ª orders è¡¨ (OrdType='New')                          â”‚
â”‚  é€šé“ 9-10:  æ¥è‡ª orders è¡¨ (IsAggressive=True)                      â”‚
â”‚  é€šé“ 11-12: æ¥è‡ª orders è¡¨ (IsAggressive=False)                     â”‚
â”‚  é€šé“ 13-14: æ¥è‡ª orders è¡¨ (OrdType='Cancel')                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.2 é€šé“æ˜ å°„é€ŸæŸ¥è¡¨

| é€šé“ | åç§° | æ•°æ®æº | ç­›é€‰æ¡ä»¶ | å¤‡æ³¨ |
|------|------|--------|----------|------|
| 0 | å…¨éƒ¨æˆäº¤ | **trades** | æ—  | |
| 1 | ä¸»åŠ¨ä¹°å…¥æˆäº¤ | **trades** | `ActiveSide == 1` | |
| 2 | ä¸»åŠ¨å–å‡ºæˆäº¤ | **trades** | `ActiveSide == 2` | |
| 3 | å¤§ä¹°å•æˆäº¤ | **trades** | `BidOrdID` æ¯å•é‡‘é¢ â‰¥ é˜ˆå€¼ | âš ï¸ **ç‹¬ç«‹åˆ¤å®šï¼Œä¸ActiveSideæ— å…³** |
| 4 | å¤§å–å•æˆäº¤ | **trades** | `AskOrdID` æ¯å•é‡‘é¢ â‰¥ é˜ˆå€¼ | âš ï¸ **ç‹¬ç«‹åˆ¤å®šï¼Œä¸ActiveSideæ— å…³** |
| 5 | å°ä¹°å•æˆäº¤ | **trades** | `BidOrdID` æ¯å•é‡‘é¢ < é˜ˆå€¼ | âš ï¸ **ç‹¬ç«‹åˆ¤å®šï¼Œä¸ActiveSideæ— å…³** |
| 6 | å°å–å•æˆäº¤ | **trades** | `AskOrdID` æ¯å•é‡‘é¢ < é˜ˆå€¼ | âš ï¸ **ç‹¬ç«‹åˆ¤å®šï¼Œä¸ActiveSideæ— å…³** |
| 7 | å…¨éƒ¨ä¹°å• | **orders** | `Side == 'B' & OrdType == 'New'` | |
| 8 | å…¨éƒ¨å–å• | **orders** | `Side == 'S' & OrdType == 'New'` | |
| 9 | ä¸»åŠ¨ä¹°å…¥å§”æ‰˜ | **orders** | `Side == 'B' & IsAggressive == True` | å…¥åœºè¿›æ”»å‹ä¹°å• |
| 10 | ä¸»åŠ¨å–å‡ºå§”æ‰˜ | **orders** | `Side == 'S' & IsAggressive == True` | å…¥åœºè¿›æ”»å‹å–å• |
| 11 | éä¸»åŠ¨ä¹°å…¥ | **orders** | `Side == 'B' & IsAggressive == False` | å…¥åœºé˜²å®ˆå‹ä¹°å• |
| 12 | éä¸»åŠ¨å–å‡º | **orders** | `Side == 'S' & IsAggressive == False` | å…¥åœºé˜²å®ˆå‹å–å• |
| 13 | æ’¤ä¹° | **orders** | `Side == 'B' & OrdType == 'Cancel'` | |
| 14 | æ’¤å– | **orders** | `Side == 'S' & OrdType == 'Cancel'` | |

**ğŸ”´ Ch3-6 å…³é”®è¯´æ˜**ï¼š

> **ä¸€ç¬”æˆäº¤åŒæ—¶å¡«å……ä¹°æ–¹å’Œå–æ–¹çš„å¤§å°å•é€šé“**
> 
> æ¯ç¬”æˆäº¤æ¶‰åŠä¹°å–åŒæ–¹ï¼Œå¿…é¡»**ç‹¬ç«‹åˆ¤å®š**ï¼š
> - ä¹°æ–¹ï¼ˆBidOrdIDï¼‰çš„æ¯å•é‡‘é¢ â†’ å†³å®šå¡«å…¥ Ch3ï¼ˆå¤§ä¹°ï¼‰æˆ– Ch5ï¼ˆå°ä¹°ï¼‰
> - å–æ–¹ï¼ˆAskOrdIDï¼‰çš„æ¯å•é‡‘é¢ â†’ å†³å®šå¡«å…¥ Ch4ï¼ˆå¤§å–ï¼‰æˆ– Ch6ï¼ˆå°å–ï¼‰
> 
> âš ï¸ **å¸¸è§é”™è¯¯**ï¼šåªæ ¹æ® ActiveSide åˆ¤å®šå¤§å°å•ï¼Œå¯¼è‡´ä¸¢å¤±ä¸€åŠä¿¡æ¯ã€‚

### 11.3 é€šé“æ•°å­¦å…³ç³»

```
é€šé“ 7 (å…¨éƒ¨ä¹°å•)  = é€šé“ 9 (ä¸»åŠ¨ä¹°) + é€šé“ 11 (éä¸»åŠ¨ä¹°)
é€šé“ 8 (å…¨éƒ¨å–å•)  = é€šé“ 10 (ä¸»åŠ¨å–) + é€šé“ 12 (éä¸»åŠ¨å–)
é€šé“ 0 (å…¨éƒ¨æˆäº¤)  = é€šé“ 1 (ä¸»åŠ¨ä¹°æˆäº¤) + é€šé“ 2 (ä¸»åŠ¨å–æˆäº¤)
```

### 11.4 å‘é‡åŒ–ä»£ç ç¤ºä¾‹ï¼ˆPolarsï¼‰

```python
import polars as pl
import numpy as np

def build_sh_image(
    orders_df: pl.DataFrame, 
    trades_df: pl.DataFrame,
    price_bins: np.ndarray,
    qty_bins: np.ndarray,
    buy_parent_amount: dict,
    sell_parent_amount: dict,
    threshold: float
) -> np.ndarray:
    """
    æ„å»ºä¸Šäº¤æ‰€å›¾åƒ
    
    Args:
        orders_df: è¿˜åŸåçš„å§”æ‰˜è¡¨ï¼ˆå« IsAggressive å­—æ®µï¼‰
        trades_df: æ ‡å‡†åŒ–æˆäº¤è¡¨ï¼ˆå« ActiveSide å­—æ®µï¼‰
        price_bins: ä»·æ ¼åˆ†ä½æ•°è¾¹ç•Œ
        qty_bins: æ•°é‡åˆ†ä½æ•°è¾¹ç•Œ
        buy_parent_amount: {BidOrdID: æ¯å•é‡‘é¢}
        sell_parent_amount: {AskOrdID: æ¯å•é‡‘é¢}
        threshold: å¤§å•é˜ˆå€¼
    """
    image = np.zeros((15, 8, 8), dtype=np.float32)
    
    # ========== æ¥è‡ª trades è¡¨çš„é€šé“: 0-6 ==========
    
    for row in trades_df.iter_rows(named=True):
        price_bin = np.searchsorted(price_bins, row['Price']) - 1
        qty_bin = np.searchsorted(qty_bins, row['Qty']) - 1
        price_bin = np.clip(price_bin, 0, 7)
        qty_bin = np.clip(qty_bin, 0, 7)
        
        # é€šé“0: å…¨éƒ¨æˆäº¤
        image[0, price_bin, qty_bin] += 1
        
        # é€šé“1-2: æ ¹æ® ActiveSide åˆ†æµ
        if row['ActiveSide'] == 1:  # ä¸»åŠ¨ä¹°å…¥
            image[1, price_bin, qty_bin] += 1
        elif row['ActiveSide'] == 2:  # ä¸»åŠ¨å–å‡º
            image[2, price_bin, qty_bin] += 1
        
        # é€šé“3-6: å¤§å°å•ï¼ˆä¸ä¸»åŠ¨æ–¹å‘æ— å…³ï¼Œç‹¬ç«‹åˆ¤å®šä¹°å–åŒæ–¹ï¼‰
        bid_id = row['BidOrdID']
        ask_id = row['AskOrdID']
        
        if bid_id in buy_parent_amount:
            if buy_parent_amount[bid_id] >= threshold:
                image[3, price_bin, qty_bin] += 1  # å¤§ä¹°å•
            else:
                image[5, price_bin, qty_bin] += 1  # å°ä¹°å•
        
        if ask_id in sell_parent_amount:
            if sell_parent_amount[ask_id] >= threshold:
                image[4, price_bin, qty_bin] += 1  # å¤§å–å•
            else:
                image[6, price_bin, qty_bin] += 1  # å°å–å•
    
    # ========== æ¥è‡ª orders è¡¨çš„é€šé“: 7-14 ==========
    
    for row in orders_df.iter_rows(named=True):
        price_bin = np.searchsorted(price_bins, row['Price']) - 1
        qty_bin = np.searchsorted(qty_bins, row['Qty']) - 1
        price_bin = np.clip(price_bin, 0, 7)
        qty_bin = np.clip(qty_bin, 0, 7)
        
        if row['OrdType'] == 'New':
            if row['Side'] == 'B':
                image[7, price_bin, qty_bin] += 1   # é€šé“7: å…¨éƒ¨ä¹°å•
                if row['IsAggressive']:
                    image[9, price_bin, qty_bin] += 1   # é€šé“9: ä¸»åŠ¨ä¹°å…¥å§”æ‰˜
                else:
                    image[11, price_bin, qty_bin] += 1  # é€šé“11: éä¸»åŠ¨ä¹°å…¥
            elif row['Side'] == 'S':
                image[8, price_bin, qty_bin] += 1   # é€šé“8: å…¨éƒ¨å–å•
                if row['IsAggressive']:
                    image[10, price_bin, qty_bin] += 1  # é€šé“10: ä¸»åŠ¨å–å‡ºå§”æ‰˜
                else:
                    image[12, price_bin, qty_bin] += 1  # é€šé“12: éä¸»åŠ¨å–å‡º
                
        elif row['OrdType'] == 'Cancel':
            if row['Side'] == 'B':
                image[13, price_bin, qty_bin] += 1  # é€šé“13: æ’¤ä¹°
            elif row['Side'] == 'S':
                image[14, price_bin, qty_bin] += 1  # é€šé“14: æ’¤å–
    
    return image
```

### 11.5 IsAggressive å­—æ®µçš„æ ¸å¿ƒä»·å€¼

| ç”¨é€” | è¯´æ˜ |
|------|------|
| **é€šé“9-12åˆ†æµ** | åŒºåˆ†"å…¥åœºè¿›æ”»å‹"ï¼ˆTakerï¼‰å’Œ"å…¥åœºé˜²å®ˆå‹"ï¼ˆMakerï¼‰å§”æ‰˜ |
| **å› å­ç ”ç©¶** | ç‹¬ç«‹è®¡ç®—"ä¸»åŠ¨å§”æ‰˜å æ¯”"ã€"æ¿€è¿›åº¦å› å­"ç­‰ |
| **ç­–ç•¥å›æµ‹** | åˆ†æä¸»åŠ¨/è¢«åŠ¨è®¢å•çš„æˆäº¤ç‡ã€æ»‘ç‚¹ç­‰ç‰¹å¾ |

### 11.6 è®¾è®¡åŸåˆ™æ€»ç»“

1. **æ„å›¾å¯¼å‘**ï¼šé€šé“9/10ç»Ÿè®¡çš„æ˜¯"å…¥åœºè¿›æ”»æ„å›¾"ï¼ˆå®Œæ•´æ¯å•é‡ï¼‰ï¼Œè€Œé"å·²å®ç°æˆäº¤é‡"
2. **Taker/Makeråˆ†ç¦»**ï¼šé€šé“9-10æ˜¯æ¶ˆè€—æµåŠ¨æ€§çš„è®¢å•ï¼Œé€šé“11-12æ˜¯æä¾›æµåŠ¨æ€§çš„è®¢å•
3. **ç‹¬ç«‹åˆ¤å®š**ï¼šCh3-6çš„å¤§å°å•åˆ¤å®šä¸ä¸»åŠ¨æ–¹å‘æ— å…³ï¼Œä¹°å–åŒæ–¹ç‹¬ç«‹åˆ¤å®š
4. **å…¥åœºç¬é—´**ï¼šIsAggressiveåªçœ‹è®¢å•é¦–æ¬¡å‡ºç°çš„ç±»å‹ï¼Œä¸çœ‹åç»­ç»å†

---

## æ–‡æ¡£ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®æ”¹å†…å®¹ |
|------|------|----------|
| v1.0 | 2026-01-21 | åˆå§‹ç‰ˆæœ¬ |
| v1.1 | 2026-01-21 | ç¡®è®¤Q5-Q7ï¼šè¢«åŠ¨æ–¹å¤„ç†ã€ActiveSideç»Ÿä¸€åŒ–ã€IsAggressiveå­—æ®µ |
| v1.2 | 2026-01-22 | ä¿®å¤å†²çª1ï¼ˆCh3-6ç‹¬ç«‹åˆ¤å®šï¼‰ã€å†²çª2ï¼ˆIsAggressiveå…¥åœºç¬é—´å®šä¹‰ï¼‰ |
| v1.3 | 2026-01-22 | åˆ é™¤é™çº§æ–¹æ¡ˆï¼Œå›¾åƒæ–¹æ¡ˆå·²å¯¹é½åˆ°æ•°æ®å¤„ç†åŸé€»è¾‘ |
| v1.4 | 2026-01-23 | åœ¨ derived_sh_orders è¾“å‡ºSchemaä¸­æ·»åŠ  BizIndex å­—æ®µï¼ˆé¦–æ¬¡å‡ºç°çš„é€ç¬”åºå·ï¼‰ |
| v1.5 | 2026-01-23 | Patch 1: ç»Ÿä¸€æ’åºé”®ä¸º (TickTime, BizIndex)ï¼›Patch 2: æ’¤å• IsAggressive æ”¹ä¸º False |
| v1.6 | 2026-01-23 | **Schema ä¿®å¤**: (1) åˆ é™¤ `_price_source` è°ƒè¯•å­—æ®µ (2) `IsAggressive` æ”¹ä¸º Nullable Boolï¼Œæ’¤å•å¡« None |
| v1.7 | 2026-01-23 | **æ‰¹é‡å¤„ç†æ’åºä¿®å¤**: å…¨å¸‚åœº parquet è¾“å‡ºå‰æŒ‰ `(SecurityID, TickTime, BizIndex)` ç‰©ç†æ’åº |
| v1.8 | 2026-01-26 | **ä¸€è‡´æ€§ä¿®å¤**: (1) æ·»åŠ å‘½åæ˜ å°„è¯´æ˜ (2) derived_sh_orders æ·»åŠ  SecurityID å­—æ®µ (3) ä¿®æ­£ä¸Šäº¤æ‰€ä¸‹åˆè¿ç»­ç«ä»·ä¸º 13:00-15:00 |

---

*æ–‡æ¡£ç»“æŸ*

# ä¸Šäº¤æ‰€/æ·±äº¤æ‰€é€ç¬”æ•°æ®é‡æ„æ¨¡å—

> **ç‰ˆæœ¬**: v2.0  
> **æ—¥æœŸ**: 2026-01-29  
> **çŠ¶æ€**: ç”Ÿäº§å°±ç»ª

---

## ğŸ“‹ ç›®å½•

- [é¡¹ç›®èƒŒæ™¯](#é¡¹ç›®èƒŒæ™¯)
- [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [æ–‡ä»¶ç»“æ„](#æ–‡ä»¶ç»“æ„)
- [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
- [è¾“å‡ºè¯´æ˜](#è¾“å‡ºè¯´æ˜)
- [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
- [æ³¨æ„äº‹é¡¹](#æ³¨æ„äº‹é¡¹)

---

## ğŸ“– é¡¹ç›®èƒŒæ™¯

### é—®é¢˜é™ˆè¿°

**ä¸Šäº¤æ‰€æ•°æ®æŒ‘æˆ˜**ï¼š
- Level-2 `auction_tick_merged_data` æ˜¯æ··åˆæ•°æ®æµï¼ˆå§”æ‰˜+æˆäº¤åˆå¹¶åœ¨ä¸€å¼ è¡¨ï¼‰
- **å³æ—¶æˆäº¤çš„å§”æ‰˜æ²¡æœ‰ Type='A' è®°å½•**ï¼šå¦‚æœä¸€ç¬”ä¹°å•æŒ‚å‡ºåç«‹å³å…¨éƒ¨æˆäº¤ï¼Œæ•°æ®ä¸­åªæœ‰ `Type='T'` æˆäº¤è®°å½•ï¼Œæ²¡æœ‰å§”æ‰˜çš„"å‡ºç”Ÿè¯æ˜"
- æ— æ³•ç›´æ¥å¾—åˆ°"æ¯å•æ„å›¾"ï¼šä¸€ç¬”1000è‚¡çš„å§”æ‰˜å¯èƒ½è¢«åˆ‡æˆå¤šæ¡æˆäº¤è®°å½•

**æ·±äº¤æ‰€æ•°æ®æŒ‘æˆ˜**ï¼š
- æ•°æ®æŒ‰ `Channel + TickTime` æ’åºï¼Œå¯¼è‡´å•è‚¡ç¥¨è¯»å–éœ€è¦å…¨è¡¨æ‰«æ
- æ€§èƒ½ç“¶é¢ˆï¼š~1.12ç§’/è‚¡ç¥¨ï¼ˆ37å€æ…¢äºé‡æ„åï¼‰

### è§£å†³æ–¹æ¡ˆ

æœ¬æ¨¡å—æä¾›ä¸¤å¥—æ•°æ®é‡æ„é€»è¾‘ï¼š

| äº¤æ˜“æ‰€ | è¾“å…¥ | å¤„ç†å†…å®¹ | è¾“å‡º | æ€§èƒ½æå‡ |
|--------|------|---------|------|----------|
| **ä¸Šäº¤æ‰€** | `{date}_sh_tick_data.parquet` | æ‹†è§£æ··åˆæµ + æ¯å•èšåˆ + ä¸»è¢«åŠ¨æ ‡è¯† | `{date}_sh_order_data.parquet`<br>`{date}_sh_trade_data.parquet` | æ•°æ®è´¨é‡æå‡ |
| **æ·±äº¤æ‰€** | `{date}_sz_trade_data.parquet`<br>`{date}_sz_order_data.parquet` | æŒ‰ SecurityID æ’åºé‡æ„ | `{date}_sz_trade_data.parquet`<br>`{date}_sz_order_data.parquet` | **37x æ€§èƒ½æå‡** |

**ç»Ÿä¸€è¾“å‡º**ï¼šä¸¤ä¸ªäº¤æ˜“æ‰€çš„è¾“å‡ºç»“æœä½¿ç”¨ç›¸åŒçš„ Schemaï¼Œä¾¿äºä¸‹æ¸¸å›¾åƒæ„å»ºæ¨¡å—ç»Ÿä¸€å¤„ç†ã€‚

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### ä¸Šäº¤æ‰€æ•°æ®æ‹†è§£ï¼ˆ`main.py`ï¼‰

1. **æ··åˆæµæ‹†è§£**ï¼šå°† `auction_tick_merged_data` æ‹†è§£ä¸ºç‹¬ç«‹çš„å§”æ‰˜è¡¨å’Œæˆäº¤è¡¨
2. **æ¯å•èšåˆ**ï¼šåŒä¸€ `OrderNO` çš„å¤šæ¡æˆäº¤è®°å½•èšåˆä¸ºä¸€æ¡å§”æ‰˜è®°å½•
3. **éšå¼å§”æ‰˜è¿˜åŸ**ï¼šè¿˜åŸå³æ—¶å…¨éƒ¨æˆäº¤çš„"éšå½¢å§”æ‰˜"ï¼ˆåªæœ‰ Type='T' è®°å½•ï¼‰
4. **ä¸»è¢«åŠ¨æ ‡è¯†**ï¼šè®¡ç®— `IsAggressive` å­—æ®µï¼ˆå…¥åœºè¿›æ”»æ€§æ ‡è¯†ï¼‰
5. **æ’¤å•ä»·æ ¼å›æº¯**ï¼šä»ç¼“å­˜å›æº¯æ’¤å•çš„åŸå§‹å§”æ‰˜ä»·
6. **æ—¶é—´è¿‡æ»¤**ï¼šå‰”é™¤é›†åˆç«ä»·æ—¶æ®µï¼ˆ09:15-09:30ï¼Œ14:57-15:00ï¼‰

**æ ¸å¿ƒä»·å€¼**ï¼š
- æ•æ‰ä¸»åŠ›èµ„é‡‘çš„çœŸå®å§”æ‰˜è§„æ¨¡ï¼ˆæ¯å•æ„å›¾ï¼‰
- åŒºåˆ† Takerï¼ˆæ¶ˆè€—æµåŠ¨æ€§ï¼‰å’Œ Makerï¼ˆæä¾›æµåŠ¨æ€§ï¼‰
- ä¸æ·±äº¤æ‰€æ•°æ®æ ¼å¼å¯¹é½ï¼Œå®ç°ç»Ÿä¸€å¤„ç†

### æ·±äº¤æ‰€æ•°æ®é‡æ„ï¼ˆ`main_sz.py`ï¼‰

1. **æŒ‰ SecurityID æ’åº**ï¼šå°†åŸå§‹æ•°æ®æŒ‰ `SecurityID + TickTime` é‡æ–°æ’åº
2. **Row Group ä¼˜åŒ–**ï¼šè®¾ç½® Row Group Size = 100,000ï¼Œå¯ç”¨ç»Ÿè®¡è£å‰ª
3. **å‹ç¼©ä¼˜åŒ–**ï¼šä½¿ç”¨ ZSTD å‹ç¼©ï¼Œå‡å°æ–‡ä»¶ä½“ç§¯

**æ ¸å¿ƒä»·å€¼**ï¼š
- å•è‚¡ç¥¨è¯»å–æ€§èƒ½ä» ~1.12ç§’ é™è‡³ ~0.03ç§’ï¼ˆ**37å€æå‡**ï¼‰
- å¯ç”¨ Parquet ç»Ÿè®¡è£å‰ªï¼ˆSkip Row Groupsï¼‰
- ä¸ä¸Šäº¤æ‰€è¾“å‡ºæ ¼å¼å¯¹é½

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒä¾èµ–

```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
conda create -n tick_processor python=3.10
conda activate tick_processor

# å®‰è£…ä¾èµ–
pip install polars pandas pyarrow
```

### è¿è¡Œç¤ºä¾‹

**ä¸Šäº¤æ‰€æ•°æ®æ‹†è§£**ï¼š
```bash
# é»˜è®¤é…ç½®ï¼ˆå¤„ç†é»˜è®¤æ—¥æœŸåŒºé—´ï¼‰
python main.py --start-date --end-date

# æŒ‡å®šå•ä¸ªæ—¥æœŸ
python main.py --date 20251031

# æŒ‡å®šæ—¥æœŸèŒƒå›´
python main.py --start-date 20251030 --end-date 20251031

# å¼ºåˆ¶é‡æ–°å¤„ç†ï¼ˆè¦†ç›–å·²æœ‰æ–‡ä»¶ï¼‰
python main.py --start-date 20251030 --end-date 20251031 --force
```

**æ·±äº¤æ‰€æ•°æ®é‡æ„**ï¼š
```bash
# é»˜è®¤é…ç½®ï¼ˆå¤„ç†é»˜è®¤æ—¥æœŸåŒºé—´ï¼‰
python main_sz.py --start-date --end-date

# æŒ‡å®šå•ä¸ªæ—¥æœŸ
python main_sz.py --date 20251031

# æŒ‡å®šæ—¥æœŸèŒƒå›´
python main_sz.py --start-date 20251030 --end-date 20251031

# åªé‡æ„æˆäº¤æ•°æ®
python main_sz.py --date 20251031 --file-type trade
```

### é…ç½®ä¿®æ”¹

**ä¿®æ”¹é»˜è®¤è·¯å¾„å’Œæ—¥æœŸåŒºé—´**ï¼ˆæ¨èï¼‰ï¼š

ç¼–è¾‘ `main.py` æˆ– `main_sz.py` ä¸­çš„ `CONFIG` å­—å…¸ï¼š

```python
CONFIG = {
    'input_dir': '/path/to/é€šè”é€ç¬”æ•°æ®',
    'output_dir': '/path/to/output',
    'start_date': '20251030',  # é»˜è®¤å¼€å§‹æ—¥æœŸ
    'end_date': '20251031',    # é»˜è®¤ç»“æŸæ—¥æœŸ
    # ... å…¶ä»–é…ç½®
}
```

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
é€ç¬”æ•°æ®åˆ†è§£/
â”œâ”€â”€ main.py                          # ä¸Šäº¤æ‰€æ•°æ®æ‹†è§£å…¥å£
â”œâ”€â”€ main_sz.py                       # æ·±äº¤æ‰€æ•°æ®é‡æ„å…¥å£
â”œâ”€â”€ sz_data_reconstructor.py         # æ·±äº¤æ‰€é‡æ„æ ¸å¿ƒé€»è¾‘
â”œâ”€â”€ README.md                        # æœ¬æ–‡æ¡£
â”œâ”€â”€ SH_Tick_Data_Reconstruction_Spec_v1.8.md  # è¯¦ç»†æŠ€æœ¯è§„æ ¼
â”‚
â”œâ”€â”€ sh_tick_reconstruction/          # ä¸Šäº¤æ‰€æ‹†è§£æ ¸å¿ƒæ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ __main__.py
â”‚   â”œâ”€â”€ reconstructor.py             # æ ¸å¿ƒé‡æ„é€»è¾‘
â”‚   â”œâ”€â”€ models.py                    # æ•°æ®æ¨¡å‹ï¼ˆOrderContextï¼‰
â”‚   â”œâ”€â”€ schema.py                    # Schema å®šä¹‰
â”‚   â”œâ”€â”€ time_filter.py               # æ—¶é—´è¿‡æ»¤
â”‚   â”œâ”€â”€ batch.py                     # æ‰¹å¤„ç†é€»è¾‘
â”‚   â”‚
â”‚   â”œâ”€â”€ scripts/
â”‚   â”‚   â”œâ”€â”€ run_daily.py             # æ‰¹é‡å¤„ç†è„šæœ¬
â”‚   â”‚   â””â”€â”€ validate_output.py       # è¾“å‡ºéªŒè¯è„šæœ¬
â”‚   â”‚
â”‚   â””â”€â”€ tests/                       # å•å…ƒæµ‹è¯•
â”‚       â”œâ”€â”€ test_batch.py
â”‚       â”œâ”€â”€ test_integration.py
â”‚       â”œâ”€â”€ test_scenarios.py
â”‚       â””â”€â”€ test_settle_orders.py
â”‚
â””â”€â”€ test_*.py                        # ç‹¬ç«‹æµ‹è¯•è„šæœ¬
```

---

## ğŸ“– ä½¿ç”¨æŒ‡å—

### ä¸Šäº¤æ‰€æ•°æ®æ‹†è§£ï¼ˆmain.pyï¼‰

#### åŸºæœ¬ç”¨æ³•

```bash
# 1. ä½¿ç”¨é»˜è®¤é…ç½®ï¼ˆCONFIG ä¸­çš„ start_date å’Œ end_dateï¼‰
python main.py --start-date --end-date

# 2. å¤„ç†å•ä¸ªæ—¥æœŸ
python main.py --date 20251031

# 3. å¤„ç†æ—¥æœŸèŒƒå›´
python main.py --start-date 20251030 --end-date 20251105

# 4. æ‰¹é‡å¤„ç†å¤šä¸ªä¸è¿ç»­æ—¥æœŸ
python main.py --dates 20251030 20251031 20251103

# 5. è‡ªå®šä¹‰è·¯å¾„
python main.py \
    --start-date 20251030 \
    --end-date 20251031 \
    --input-dir /path/to/input \
    --output-dir /path/to/output

# 6. å¼ºåˆ¶é‡æ–°å¤„ç†ï¼ˆè¦†ç›–å·²æœ‰æ–‡ä»¶ï¼‰
python main.py --date 20251031 --force

# 7. è·³è¿‡è¾“å‡ºéªŒè¯ï¼ˆæå‡æ€§èƒ½ï¼‰
python main.py --date 20251031 --no-validate
```

#### å‘½ä»¤è¡Œå‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `--date` | å•ä¸ªæ—¥æœŸ YYYYMMDD | CONFIG['default_date'] |
| `--dates` | å¤šä¸ªæ—¥æœŸåˆ—è¡¨ | - |
| `--start-date` | å¼€å§‹æ—¥æœŸ | CONFIG['start_date'] |
| `--end-date` | ç»“æŸæ—¥æœŸ | CONFIG['end_date'] |
| `--input-dir` | è¾“å…¥ç›®å½• | CONFIG['input_dir'] |
| `--output-dir` | è¾“å‡ºç›®å½• | CONFIG['output_dir'] |
| `--force` | å¼ºåˆ¶é‡æ–°å¤„ç† | False |
| `--no-validate` | è·³è¿‡è¾“å‡ºéªŒè¯ | False |

#### æ–­ç‚¹ç»­ä¼ 

- é»˜è®¤å¯ç”¨æ–­ç‚¹ç»­ä¼ ï¼ˆ`CONFIG['skip_existing'] = True`ï¼‰
- å¦‚æœè¾“å‡ºæ–‡ä»¶å·²å­˜åœ¨ï¼Œè‡ªåŠ¨è·³è¿‡
- ä½¿ç”¨ `--force` å¼ºåˆ¶è¦†ç›–

### æ·±äº¤æ‰€æ•°æ®é‡æ„ï¼ˆmain_sz.pyï¼‰

#### åŸºæœ¬ç”¨æ³•

```bash
# 1. ä½¿ç”¨é»˜è®¤é…ç½®
python main_sz.py --start-date --end-date

# 2. å¤„ç†å•ä¸ªæ—¥æœŸ
python main_sz.py --date 20251031

# 3. å¤„ç†æ—¥æœŸèŒƒå›´
python main_sz.py --start-date 20251030 --end-date 20251031

# 4. åªé‡æ„æˆäº¤æ•°æ®
python main_sz.py --date 20251031 --file-type trade

# 5. åªé‡æ„å§”æ‰˜æ•°æ®
python main_sz.py --date 20251031 --file-type order

# 6. è‡ªå®šä¹‰ Row Group å¤§å°
python main_sz.py --date 20251031 --row-group-size 50000

# 7. è‡ªå®šä¹‰å‹ç¼©ç®—æ³•
python main_sz.py --date 20251031 --compression lz4
```

#### å‘½ä»¤è¡Œå‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `--date` | å•ä¸ªæ—¥æœŸ YYYYMMDD | CONFIG['default_date'] |
| `--dates` | å¤šä¸ªæ—¥æœŸåˆ—è¡¨ | - |
| `--start-date` | å¼€å§‹æ—¥æœŸ | CONFIG['start_date'] |
| `--end-date` | ç»“æŸæ—¥æœŸ | CONFIG['end_date'] |
| `--input-dir` | è¾“å…¥ç›®å½• | CONFIG['input_dir'] |
| `--output-dir` | è¾“å‡ºç›®å½• | CONFIG['output_dir'] |
| `--file-type` | é‡æ„ç±»å‹ (trade/order/both) | 'both' |
| `--row-group-size` | Row Group å¤§å° | 100,000 |
| `--compression` | å‹ç¼©ç®—æ³• (zstd/lz4/snappy) | 'zstd' |
| `--force` | å¼ºåˆ¶é‡æ–°å¤„ç† | False |

---

## ğŸ“Š è¾“å‡ºè¯´æ˜

### ç»Ÿä¸€è¾“å‡ºç›®å½•

**æ‰€æœ‰æ•°æ®è¾“å‡ºåˆ° `output/` ç›®å½•**ï¼ˆæ²ªæ·±ç»Ÿä¸€ï¼‰ï¼š

```
output/
â”œâ”€â”€ 20251030_sh_order_data.parquet   # ä¸Šäº¤æ‰€å§”æ‰˜è¡¨
â”œâ”€â”€ 20251030_sh_trade_data.parquet   # ä¸Šäº¤æ‰€æˆäº¤è¡¨
â”œâ”€â”€ 20251030_sz_order_data.parquet   # æ·±äº¤æ‰€å§”æ‰˜è¡¨ï¼ˆé‡æ„åï¼‰
â”œâ”€â”€ 20251030_sz_trade_data.parquet   # æ·±äº¤æ‰€æˆäº¤è¡¨ï¼ˆé‡æ„åï¼‰
â”œâ”€â”€ 20251031_sh_order_data.parquet
â”œâ”€â”€ 20251031_sh_trade_data.parquet
â”œâ”€â”€ 20251031_sz_order_data.parquet
â””â”€â”€ 20251031_sz_trade_data.parquet
```

### ä¸Šäº¤æ‰€å§”æ‰˜è¡¨ Schema (`{date}_sh_order_data.parquet`)

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `SecurityID` | varchar | è¯åˆ¸ä»£ç  |
| `BizIndex` | int | é¦–æ¬¡å‡ºç°çš„é€ç¬”åºå·ï¼ˆç”¨äºæ’åºå’Œå®¡è®¡ï¼‰ |
| `TickTime` | int | å§”æ‰˜æ—¶é—´ (HHMMSSmmm) |
| `OrdID` | int | å§”æ‰˜å•å· |
| `OrdType` | enum | `New` / `Cancel` |
| `Side` | enum | `B` / `S` |
| `Price` | decimal | å§”æ‰˜ä»·æ ¼ |
| `Qty` | int | **åŸå§‹å§”æ‰˜é‡**ï¼ˆæ¯å•èšåˆåï¼‰ |
| `IsAggressive` | nullable bool | **å…¥åœºè¿›æ”»æ€§æ ‡è¯†**ï¼ˆ`True`=Taker, `False`=Maker, `None`=æ’¤å•ï¼‰ |

**IsAggressive è¯´æ˜**ï¼š
- `True`ï¼šé¦–æ¬¡å‡ºç°ä¸º `Type='T'`ï¼ˆå‡ºç”Ÿå³æˆäº¤ï¼Œæ¶ˆè€—æµåŠ¨æ€§ï¼‰
- `False`ï¼šé¦–æ¬¡å‡ºç°ä¸º `Type='A'`ï¼ˆå‡ºç”Ÿå³æŒ‚å•ï¼Œæä¾›æµåŠ¨æ€§ï¼‰
- `None`ï¼šæ’¤å•è®°å½•ï¼ˆ`OrdType='Cancel'`ï¼‰

### ä¸Šäº¤æ‰€æˆäº¤è¡¨ Schema (`{date}_sh_trade_data.parquet`)

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `SecurityID` | varchar | è¯åˆ¸ä»£ç  |
| `TickTime` | int | æˆäº¤æ—¶é—´ |
| `BizIndex` | int | é€ç¬”åºå· |
| `BidOrdID` | int | ä¹°å•å· |
| `AskOrdID` | int | å–å•å· |
| `Price` | decimal | æˆäº¤ä»· |
| `Qty` | int | æˆäº¤é‡ |
| `TradeMoney` | decimal | æˆäº¤é‡‘é¢ |
| `ActiveSide` | int | **ç»Ÿä¸€ä¸»åŠ¨æ–¹å‘**ï¼ˆ`1`=ä¸»åŠ¨ä¹°, `2`=ä¸»åŠ¨å–, `0`=æœªçŸ¥ï¼‰ |

**ActiveSide è¯´æ˜**ï¼ˆæ²ªæ·±ç»Ÿä¸€åŒ–ï¼‰ï¼š
- ä¸Šäº¤æ‰€ï¼šç›´æ¥æ˜ å°„ `TickBSFlag` (`'B'`â†’1, `'S'`â†’2, `'N'`â†’0)
- æ·±äº¤æ‰€ï¼šæ ¹æ® `BidApplSeqNum` å’Œ `OfferApplSeqNum` åˆ¤å®š
- ç»Ÿä¸€å­—æ®µä¾¿äºä¸‹æ¸¸å›¾åƒæ„å»ºçš„å‘é‡åŒ–è®¡ç®—

### æ·±äº¤æ‰€æ•°æ® Schema

**æ·±äº¤æ‰€æ•°æ®é‡æ„åä¿æŒä¸ä¸Šäº¤æ‰€ç›¸åŒçš„ Schema**ï¼ˆå·²åœ¨åŸå§‹æ•°æ®å¤„ç†æ—¶æ ‡å‡†åŒ–ï¼‰ã€‚

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ•°æ®æµæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Phase 1: æ•°æ®é‡æ„ï¼ˆæœ¬æ¨¡å—ï¼‰                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¸Šäº¤æ‰€åŸå§‹æ•°æ®                    æ·±äº¤æ‰€åŸå§‹æ•°æ®                  â”‚
â”‚  {date}_sh_tick_data.parquet     {date}_sz_{trade|order}.parquetâ”‚
â”‚           â”‚                                â”‚                     â”‚
â”‚           â–¼                                â–¼                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚   main.py       â”‚              â”‚   main_sz.py    â”‚           â”‚
â”‚  â”‚  æ‹†è§£+èšåˆ+æ ‡è¯†   â”‚              â”‚ SecurityIDæ’åº  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚           â”‚                                â”‚                     â”‚
â”‚           â–¼                                â–¼                     â”‚
â”‚  output/{date}_sh_order_data.parquet  output/{date}_sz_...      â”‚
â”‚  output/{date}_sh_trade_data.parquet                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Phase 2: å›¾åƒæ„å»ºï¼ˆl2_image_builderï¼‰              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é€šé“ 0-6:   æ¥è‡ª trades è¡¨                                      â”‚
â”‚  é€šé“ 7-8:   æ¥è‡ª orders è¡¨ (OrdType='New')                     â”‚
â”‚  é€šé“ 9-10:  æ¥è‡ª orders è¡¨ (IsAggressive=True)                 â”‚
â”‚  é€šé“ 11-12: æ¥è‡ª orders è¡¨ (IsAggressive=False)                â”‚
â”‚  é€šé“ 13-14: æ¥è‡ª orders è¡¨ (OrdType='Cancel')                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸Šäº¤æ‰€æ ¸å¿ƒé€»è¾‘

**OrderMap ç¼“å­˜è®¾è®¡**ï¼š

```python
@dataclass
class OrderContext:
    order_no: int           # è®¢å•å·
    side: str               # 'B' or 'S'
    first_time: int         # é¦–æ¬¡å‡ºç°æ—¶é—´
    first_biz_index: int    # é¦–æ¬¡å‡ºç°çš„BizIndex
    
    trade_qty: int = 0      # ç´¯è®¡æˆäº¤é‡
    resting_qty: int = 0    # æŒ‚å•é‡
    
    trade_price: float = 0  # æœ€æ–°æˆäº¤ä»·
    resting_price: float = 0  # æŒ‚å•ä»·
    
    is_aggressive: bool = False  # å…¥åœºè¿›æ”»æ€§ï¼ˆåªçœ‹é¦–æ¬¡ç±»å‹ï¼‰
```

**å¤„ç†æµç¨‹**ï¼š

1. **æ—¶é—´è¿‡æ»¤**ï¼šå‰”é™¤é›†åˆç«ä»·æ—¶æ®µï¼ˆ09:15-09:30, 14:57-15:00ï¼‰
2. **æ’åº**ï¼šæŒ‰ `(TickTime, BizIndex)` ä¸¥æ ¼æ’åº
3. **é€è¡Œå¤„ç†**ï¼š
   - `Type='T'`ï¼šè¾“å‡ºæˆäº¤è®°å½• + ç´¯åŠ ä¸»åŠ¨æ–¹åˆ° OrderMap
   - `Type='A'`ï¼šæ›´æ–° OrderMapï¼ˆå‰©ä½™æŒ‚å•ï¼‰
   - `Type='D'`ï¼šç›´æ¥è¾“å‡ºæ’¤å•è®°å½•ï¼ˆä»ç¼“å­˜å›æº¯ä»·æ ¼ï¼‰
4. **æ¯å•ç»“ç®—**ï¼šéå† OrderMapï¼Œè¾“å‡ºèšåˆåçš„ New å§”æ‰˜

### æ·±äº¤æ‰€æ ¸å¿ƒé€»è¾‘

**Polars å‘é‡åŒ–æ’åº**ï¼š

```python
def reconstruct_sz_parquet(date, input_dir, output_dir, ...):
    # ä½¿ç”¨ Polars lazy scan è¿›è¡Œå…¨å±€æ’åº
    df = pl.scan_parquet(input_file).sort(['SecurityID', 'TickTime'])
    
    # å†™å…¥ Parquetï¼Œè®¾ç½® Row Group Size
    df.collect().write_parquet(
        output_file,
        row_group_size=100_000,
        compression='zstd'
    )
```

**æ€§èƒ½ä¼˜åŒ–åŸç†**ï¼š
- Row Group ç»Ÿè®¡è£å‰ªï¼šParquet è®°å½•æ¯ä¸ª Row Group çš„ `SecurityID` min/max
- å•è‚¡ç¥¨æŸ¥è¯¢æ—¶ï¼Œç›´æ¥è·³è¿‡ä¸ç›¸å…³çš„ Row Group
- æ€§èƒ½æå‡ï¼š~1.12ç§’ â†’ ~0.03ç§’ï¼ˆ**37å€**ï¼‰

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### æ•°æ®è´¨é‡

1. **BizIndex è¿ç»­æ€§**ï¼šå¦‚æœæ£€æµ‹åˆ°è·³å·ï¼Œå¯èƒ½æœ‰æ•°æ®ä¸¢å¤±ï¼ŒOrderMap å¯èƒ½ä¸å®Œæ•´
2. **æ’¤å•ä»·æ ¼**ï¼šæ’¤å•çš„ `Price` å­—æ®µæ— æ„ä¹‰ï¼Œå¿…é¡»ä»ç¼“å­˜å›æº¯ï¼ˆåˆ†çº§å…œåº•ç­–ç•¥ï¼‰
3. **æ—¶é—´è¿‡æ»¤**ï¼šåŠ¡å¿…å‰”é™¤é›†åˆç«ä»·æ—¶æ®µï¼Œå¦åˆ™ `ActiveSide` åˆ¤å®šå¤±æ•ˆ

### æ€§èƒ½å»ºè®®

1. **åˆ†æ®µå¤„ç†**ï¼šå¦‚æœå¤„ç†å¤§é‡æ—¥æœŸï¼Œå»ºè®®åˆ†æ®µè¿è¡Œï¼ˆé¿å…å†…å­˜å‹åŠ›ï¼‰
2. **æ–­ç‚¹ç»­ä¼ **ï¼šé»˜è®¤å¯ç”¨ï¼Œå¦‚éœ€è¦†ç›–ä½¿ç”¨ `--force`
3. **Row Group å¤§å°**ï¼šæ·±äº¤æ‰€é‡æ„é»˜è®¤ 100,000 è¡Œ/ç»„ï¼Œå¯æ ¹æ®å†…å­˜æƒ…å†µè°ƒæ•´

### IsAggressive å¸¸è§è¯¯è§£

| åœºæ™¯ | é”™è¯¯ç†è§£ | æ­£ç¡®ç†è§£ |
|------|---------|---------|
| è¢«åŠ¨å•åç»­æˆäº¤ | 9:30æŒ‚å•(A)ï¼Œ10:00è¢«ç ¸æˆäº¤(T) â†’ True? | **False**ï¼ˆé¦–æ¬¡æ˜¯Aï¼‰ |
| ä¸»åŠ¨å•éƒ¨åˆ†æˆäº¤ | å…ˆæˆäº¤(T)ï¼Œå†æŒ‚å•(A) â†’ False? | **True**ï¼ˆé¦–æ¬¡æ˜¯Tï¼‰ |
| çº¯æŒ‚å• | å…¨ç¨‹åªæœ‰A â†’ False | **False**ï¼ˆæ­£ç¡®ï¼‰ |
| å³æ—¶å…¨éƒ¨æˆäº¤ | å…¨ç¨‹åªæœ‰T â†’ True | **True**ï¼ˆæ­£ç¡®ï¼‰ |
| æ’¤å•è®°å½• | IsAggressive=False? | **None**ï¼ˆä¸é€‚ç”¨ï¼‰ |

**æ ¸å¿ƒåŸåˆ™**ï¼šåªçœ‹"å‡ºç”Ÿæ–¹å¼"ï¼Œä¸çœ‹"åç»­ç»å†"ã€‚

### é€šé“æ•°å­¦éªŒè¯

```python
# å§”æ‰˜é€šé“å…³ç³»
Ch7 (å…¨éƒ¨ä¹°å•)  = Ch9 (ä¸»åŠ¨ä¹°) + Ch11 (éä¸»åŠ¨ä¹°)
Ch8 (å…¨éƒ¨å–å•)  = Ch10 (ä¸»åŠ¨å–) + Ch12 (éä¸»åŠ¨å–)

# æˆäº¤é€šé“å…³ç³»
Ch0 (å…¨éƒ¨æˆäº¤)  = Ch1 (ä¸»åŠ¨ä¹°æˆäº¤) + Ch2 (ä¸»åŠ¨å–æˆäº¤)
```

---

## ğŸ“š å»¶ä¼¸é˜…è¯»

- **è¯¦ç»†æŠ€æœ¯è§„æ ¼**ï¼š[SH_Tick_Data_Reconstruction_Spec_v1.8.md](SH_Tick_Data_Reconstruction_Spec_v1.8.md)
- **å›¾åƒæ„å»ºæ¨¡å—**ï¼š`../l2_image_builder/`
- **æµ‹è¯•ç”¨ä¾‹**ï¼š`sh_tick_reconstruction/tests/`

---

## ğŸ”„ ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®æ”¹å†…å®¹ |
|------|------|----------|
| v1.0 | 2026-01-23 | åˆå§‹ç‰ˆæœ¬ï¼ˆä¸Šäº¤æ‰€æ‹†è§£ï¼‰ |
| v1.5 | 2026-01-26 | æ·»åŠ æ·±äº¤æ‰€é‡æ„æ¨¡å— |
| v2.0 | 2026-01-29 | ç»Ÿä¸€è¾“å‡ºç›®å½• + æ·»åŠ æ—¥æœŸåŒºé—´é…ç½® + README æ–‡æ¡£ |

---

**ç»´æŠ¤è€…**: ä¸­é‚®åŸºé‡‘é‡åŒ–å›¢é˜Ÿ  
**è”ç³»æ–¹å¼**: å‚è€ƒé¡¹ç›®ä¸» README
